;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; Changes
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2016
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.changes jazz


(import (world)
        (world.autoload)
        (world.change)
        (world.entity)
        (world.geometry)
        (world.syntax (phase syntax)))


(define-change move
  forward-store: (lambda (push entity new-position)
                   (push (cast <fl> (get-id~ entity)))
                   (push (vertex-x new-position))
                   (push (vertex-y new-position))
                   (push (vertex-z new-position)))
  forward-apply: (lambda (pop)
                   (let* ((id (pop))
                          (x (pop))
                          (y (pop))
                          (z (pop)))
                     (let ((entity (id->entity (flonum->fixnum id))))
                       (set-position~ entity (vertex& x y z)))))
  backward-store: (lambda (push entity old-position)
                    (push (cast <fl> (get-id~ entity)))
                    (push (vertex-x old-position))
                    (push (vertex-y old-position))
                    (push (vertex-z old-position)))
  backward-apply: (lambda (pop)
                    (let* ((id (pop))
                           (x (pop))
                           (y (pop))
                           (z (pop)))
                      (let ((entity (id->entity (flonum->fixnum id))))
                        (set-position~ entity (vertex& x y z))))))


(define-change add
  forward-store: (lambda (push x y z id data-id)
                   (push x)
                   (push y)
                   (push z)
                   (push (cast <fl> id))
                   (push (cast <fl> data-id)))
  forward-apply: (lambda (pop)
                   (let* ((x (pop))
                          (y (pop))
                          (z (pop))
                          (id (pop))
                          (data-id (pop)))
                     (let ((pos (vertex& x y z))
                           (id (flonum->fixnum id))
                           (data-id (flonum->fixnum data-id)))
                       (apply-add-block~ (current-game) pos id data-id))))
  backward-store: (lambda (push x y z replaced replaced-data)
                    (push x)
                    (push y)
                    (push z)
                    (push (cast <fl> replaced))
                    (push (cast <fl> replaced-data)))
  backward-apply: (lambda (pop)
                    (let* ((x (pop))
                           (y (pop))
                           (z (pop))
                           (replaced (pop))
                           (replaced-data (pop)))
                      (let ((pos (vertex& x y z))
                            (replaced (flonum->fixnum replaced))
                            (replaced-data (flonum->fixnum replaced-data)))
                        (apply-restore-block~ (current-game) pos replaced replaced-data)))))


(define-change delete
  forward-store: (lambda (push x y z)
                   (push x)
                   (push y)
                   (push z))
  forward-apply: (lambda (pop)
                   (let* ((x (pop))
                          (y (pop))
                          (z (pop)))
                     (let ((pos (vertex& x y z)))
                       (apply-delete-block~ (current-game) pos))))
  backward-store: (lambda (push x y z block-id data-id)
                    (push x)
                    (push y)
                    (push z)
                    (push (cast <fl> block-id))
                    (push (cast <fl> data-id)))
  backward-apply: (lambda (pop)
                    (let* ((x (pop))
                           (y (pop))
                           (z (pop))
                           (block-id (pop))
                           (data-id (pop)))
                      (let ((pos (vertex& x y z))
                            (block-id (flonum->fixnum block-id))
                            (data-id (flonum->fixnum data-id)))
                        (apply-restore-block~ (current-game) pos block-id data-id))))))
