;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; Changes
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2016
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.changes jazz


(import (world)
        (world.autoload)
        (world.change)
        (world.entity)
        (world.geometry)
        (world.syntax (phase syntax)))


;;;
;;;; Move
;;;


(define-change move
  forward-count: 4
  forward-store: (lambda (push entity new-position)
                   (push (cast <fl> (get-id~ entity)))
                   (push (vertex-x new-position))
                   (push (vertex-y new-position))
                   (push (vertex-z new-position)))
  forward-apply: (lambda (pop)
                   (let* ((id (pop))
                          (x (pop))
                          (y (pop))
                          (z (pop)))
                     (let ((entity (id->entity (flonum->fixnum id))))
                       (set-position~ entity (vertex& x y z)))))
  backward-store: (lambda (push entity old-position)
                    (push (cast <fl> (get-id~ entity)))
                    (push (vertex-x old-position))
                    (push (vertex-y old-position))
                    (push (vertex-z old-position)))
  backward-apply: (lambda (pop)
                    (let* ((id (pop))
                           (x (pop))
                           (y (pop))
                           (z (pop)))
                      (let ((entity (id->entity (flonum->fixnum id))))
                        (set-position~ entity (vertex& x y z))))))


(definition protected (move-change entity old-position new-position)
  (let ((world (current-world))
        (history (current-history)))
    (let ((id (get-id~ entity)))
      (unless (or (not id)
                  (get-paused?~ history)
                  (vertex-near? new-position old-position)
                  (server-side?))
        (change 'move
          (lambda (store push)
            (store push entity new-position))
          (lambda (store push)
            (store push entity old-position))
          metadata: (snapshot-metadata~ world))))))


;;;
;;;; Lookat
;;;


(define-change lookat
  forward-count: 10
  forward-store: (lambda (push entity new-lookat)
                   (let ((sight (get-sight~ new-lookat))
                         (up (get-up~ new-lookat))
                         (right (get-right~ new-lookat)))
                     (push (cast <fl> (get-id~ entity)))
                     (push (vertex-x sight))
                     (push (vertex-y sight))
                     (push (vertex-z sight))
                     (push (vertex-x up))
                     (push (vertex-y up))
                     (push (vertex-z up))
                     (push (vertex-x right))
                     (push (vertex-y right))
                     (push (vertex-z right))))
  forward-apply: (lambda (pop)
                   (let* ((id (pop))
                          (sx (pop))
                          (sy (pop))
                          (sz (pop))
                          (ux (pop))
                          (uy (pop))
                          (uz (pop))
                          (rx (pop))
                          (ry (pop))
                          (rz (pop)))
                     (let ((entity (id->entity (flonum->fixnum id))))
                       (set-lookat~ entity (lookat& (vertex& sx sy sz) (vertex& ux uy uz) (vertex& rx ry rz))))))
  backward-store: (lambda (push entity old-lookat)
                    (let ((sight (get-sight~ old-lookat))
                          (up (get-up~ old-lookat))
                          (right (get-right~ old-lookat)))
                      (push (cast <fl> (get-id~ entity)))
                      (push (vertex-x sight))
                      (push (vertex-y sight))
                      (push (vertex-z sight))
                      (push (vertex-x up))
                      (push (vertex-y up))
                      (push (vertex-z up))
                      (push (vertex-x right))
                      (push (vertex-y right))
                      (push (vertex-z right))))
  backward-apply: (lambda (pop)
                    (let* ((id (pop))
                           (sx (pop))
                           (sy (pop))
                           (sz (pop))
                           (ux (pop))
                           (uy (pop))
                           (uz (pop))
                           (rx (pop))
                           (ry (pop))
                           (rz (pop)))
                      (let ((entity (id->entity (flonum->fixnum id))))
                        (set-lookat~ entity (lookat& (vertex& sx sy sz) (vertex& ux uy uz) (vertex& rx ry rz)))))))


(definition protected (lookat-change entity old-lookat new-lookat)
  (let ((world (current-world))
        (history (current-history)))
    (let ((id (get-id~ entity)))
      (unless (or (not id)
                  (get-paused?~ history)
                  (lookat-near? new-lookat old-lookat)
                  (server-side?))
        (change 'lookat
          (lambda (store push)
            (store push entity new-lookat))
          (lambda (store push)
            (store push entity old-lookat))
          metadata: (snapshot-metadata~ world))))))


;;;
;;;; Add
;;;


(define-change add
  forward-count: 5
  forward-store: (lambda (push x y z id data-id)
                   (push x)
                   (push y)
                   (push z)
                   (push (cast <fl> id))
                   (push (cast <fl> data-id)))
  forward-apply: (lambda (pop)
                   (let* ((x (pop))
                          (y (pop))
                          (z (pop))
                          (id (pop))
                          (data-id (pop)))
                     (let ((pos (vertex& x y z))
                           (id (flonum->fixnum id))
                           (data-id (flonum->fixnum data-id)))
                       (apply-add-block~ (current-game) pos id data-id))))
  backward-store: (lambda (push x y z replaced replaced-data)
                    (push x)
                    (push y)
                    (push z)
                    (push (cast <fl> replaced))
                    (push (cast <fl> replaced-data)))
  backward-apply: (lambda (pop)
                    (let* ((x (pop))
                           (y (pop))
                           (z (pop))
                           (replaced (pop))
                           (replaced-data (pop)))
                      (let ((pos (vertex& x y z))
                            (replaced (flonum->fixnum replaced))
                            (replaced-data (flonum->fixnum replaced-data)))
                        (apply-restore-block~ (current-game) pos replaced replaced-data)))))


;;;
;;;; Delete
;;;


(define-change delete
  forward-count: 3
  forward-store: (lambda (push x y z)
                   (push x)
                   (push y)
                   (push z))
  forward-apply: (lambda (pop)
                   (let* ((x (pop))
                          (y (pop))
                          (z (pop)))
                     (let ((pos (vertex& x y z)))
                       (apply-delete-block~ (current-game) pos))))
  backward-store: (lambda (push x y z block-id data-id)
                    (push x)
                    (push y)
                    (push z)
                    (push (cast <fl> block-id))
                    (push (cast <fl> data-id)))
  backward-apply: (lambda (pop)
                    (let* ((x (pop))
                           (y (pop))
                           (z (pop))
                           (block-id (pop))
                           (data-id (pop)))
                      (let ((pos (vertex& x y z))
                            (block-id (flonum->fixnum block-id))
                            (data-id (flonum->fixnum data-id)))
                        (apply-restore-block~ (current-game) pos block-id data-id))))))
