;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; World Target
;;;
;;;  The contents of this file are subject to the Mozilla Public License Version
;;;  1.1 (the "License"); you may not use this file except in compliance with
;;;  the License. You may obtain a copy of the License at
;;;  http://www.mozilla.org/MPL/
;;;
;;;  Software distributed under the License is distributed on an "AS IS" basis,
;;;  WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
;;;  for the specific language governing rights and limitations under the
;;;  License.
;;;
;;;  The Original Code is WorldScheme.
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2014
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):
;;;
;;;  Alternatively, the contents of this file may be used under the terms of
;;;  the GNU General Public License Version 2 or later (the "GPL"), in which
;;;  case the provisions of the GPL are applicable instead of those above. If
;;;  you wish to allow use of your version of this file only under the terms of
;;;  the GPL, and not to allow others to use your version of this file under the
;;;  terms of the MPL, indicate your decision by deleting the provisions above
;;;  and replace them with the notice and other provisions required by the GPL.
;;;  If you do not delete the provisions above, a recipient may use your version
;;;  of this file under the terms of any one of the MPL or the GPL.
;;;
;;;  See http://github.com/gcartier/world for details.


(module world.target jazz


(import (jazz.geometry)
        (jazz.graphic.opengl.glew)
        (world)
        (world.autoload)
        (world.dye)
        (world.dyes)
        (world.foreign)
        (world.generate)
        (world.geometry)
        (world.opengl)
        (world.quad)
        (world.syntax (phase syntax))
        (world.widget))


;;;
;;;; Widget
;;;


(class Target-Widget extends Widget
  
  
  (slot last-point initialize #f)
  
  
  (method (colorize-dye name default (alpha #f))
    (let ((world (current-world)))
      (let ((down (get-widget-down~ world))
            (part (get-widget-part~ world)))
        (gl-colorize-dye
          (if (and (eq? self down) (eq? part name))
              (if alpha
                  (dye 1. 1. 0. alpha)
                yellow-dye)
            default))))))


;;;
;;;; Mover
;;;


(class Mover extends Target-Widget
  
  
  (slot contact-offset)


  (method override (draw-widget)
    (let ((world (current-world)))
      (let ((target (first-target~ world)))
        (let ((x (get-x~ target))
              (y (get-y~ target))
              (z (get-z~ target))
              (sx (+ 1.5 (get-radius-x~ target)))
              (sy (+ 1.5 (get-radius-y~ target)))
              (sz (+ 1.5 (get-radius-z~ target)))
              (ps .5)
              (pa .4))
          (glLineWidth 2.)
          (glDisable GL_LIGHTING)
          (glDisable GL_DEPTH_TEST)
          (glBegin GL_LINES)
          ;; Axis X
          (colorize-dye 'x red-dye)
          (glVertex3f (+ x 0.0) y (+ z 0.0))
          (glVertex3f (+ x  sx) y (+ z 0.0))
          
          ;; Axis Y
          (colorize-dye 'y green-dye)
          (glVertex3f (+ x 0.0) (+ y 0.0) z)
          (glVertex3f (+ x 0.0) (+ y  sy) z)
          
          ;; Axis Z
          (colorize-dye 'z blue-dye)
          (glVertex3f (+ x 0.0) y (+ z 0.0))
          (glVertex3f (+ x 0.0) y (+ z  sz))
          (glEnd)
          (glLineWidth 1.)
          
          ;; Plane X
          (colorize-dye 'plane-x (dye 1. 0. 0. pa) pa)
          (glBegin GL_QUADS)
          (glVertex3f x y z)
          (glVertex3f x y (+ z ps))
          (glVertex3f x (+ y ps) (+ z ps))
          (glVertex3f x (+ y ps) z)
          (glEnd)
          (colorize-dye 'plane-x red-dye)
          (glBegin GL_LINE_STRIP)
          (glVertex3f x y (+ z ps))
          (glVertex3f x (+ y ps) (+ z ps))
          (glVertex3f x (+ y ps) z)
          (glEnd)
          
          ;; Plane Y
          (colorize-dye 'plane-y (dye 0. 1. 0. pa) pa)
          (glBegin GL_QUADS)
          (glVertex3f x y z)
          (glVertex3f x y (+ z ps))
          (glVertex3f (+ x ps) y (+ z ps))
          (glVertex3f (+ x ps) y z)
          (glEnd)
          (colorize-dye 'plane-y green-dye)
          (glBegin GL_LINE_STRIP)
          (glVertex3f x y (+ z ps))
          (glVertex3f (+ x ps) y (+ z ps))
          (glVertex3f (+ x ps) y z)
          (glEnd)
          
          ;; Plane Z
          (colorize-dye 'plane-z (dye 0. 0. 1. pa) pa)
          (glBegin GL_QUADS)
          (glVertex3f x y z)
          (glVertex3f x (+ y ps) z)
          (glVertex3f (+ x ps) (+ y ps) z)
          (glVertex3f (+ x ps) y z)
          (glEnd)
          (colorize-dye 'plane-z blue-dye)
          (glBegin GL_LINE_STRIP)
          (glVertex3f x (+ y ps) z)
          (glVertex3f (+ x ps) (+ y ps) z)
          (glVertex3f (+ x ps) y z)
          (glEnd)
          
          ;; Arrow X
          (glPushMatrix)
          (glTranslatef (+ x sx) y z)
          (glRotatef 90.0 0.0 1.0 0.0)
          (glScalef 0.1 0.1 0.1)
          (colorize-dye 'x red-dye)
          (gl-cylinder 1. 0. 2. 26 52)
          (glPopMatrix)
          
          ;; Arrow Y
          (glPushMatrix)
          (glTranslatef x (+ y sy) z)
          (glRotatef -90.0 1.0 0.0 0.0)
          (glScalef 0.1 0.1 0.1)
          (colorize-dye 'y green-dye)
          (gl-cylinder 1. 0. 2. 26 52)
          (glPopMatrix)
          
          ;; Arrow Z
          (glPushMatrix)
          (glTranslatef x y (+ z sz))
          (glRotatef -90.0 0.0 0.0 1.0)
          (glScalef 0.1 0.1 0.1)
          (colorize-dye 'z blue-dye)
          (gl-cylinder 1. 0. 2. 26 52)
          (glPopMatrix)
          (glEnable GL_LIGHTING)
          (glEnable GL_DEPTH_TEST)))))
  
  
  (method override (iterate-polygons proc)
    (let ((world (current-world)))
      (let ((target (first-target~ world)))
        (when (and target (target-moveable?~ target))
          (let ((x (get-x~ target))
                (y (get-y~ target))
                (z (get-z~ target))
                (sx (+ 1.5 (get-radius-x~ target)))
                (sy (+ 1.5 (get-radius-y~ target)))
                (sz (+ 1.5 (get-radius-z~ target)))
                (ps .5)
                (cuboid (make-cuboid))
                (cr .1)
                (ar .05))
            (define (iterate-plane v1 v2 v3 v4 part)
              (proc (make-quad (cons self part)
                               v1 v2 v3 v4)))
            
            (define (iterate-arrow x y z part)
              (cuboid-init! cuboid (- x cr) (- y cr) (- z cr) (+ x cr) (+ y cr) (+ z cr))
              (iterate-cuboid-quads cuboid (cons self part) proc))
            
            (define (iterate-axis left bottom back right top front part)
              (cuboid-init! cuboid left bottom back right top front)
              (iterate-cuboid-quads cuboid (cons self part) proc))
            
            (iterate-plane (vertex x y z)
                           (vertex x y (+ z ps))
                           (vertex x (+ y ps) (+ z ps))
                           (vertex x (+ y ps) z)
                           'plane-x)
            (iterate-plane (vertex x y z)
                           (vertex x y (+ z ps))
                           (vertex (+ x ps) y (+ z ps))
                           (vertex (+ x ps) y z)
                           'plane-y)
            (iterate-plane (vertex x y z)
                           (vertex x (+ y ps) z)
                           (vertex (+ x ps) (+ y ps) z)
                           (vertex (+ x ps) y z)
                           'plane-z)
            (iterate-arrow (+ x sx) y z 'x)
            (iterate-arrow x (+ y sy) z 'y)
            (iterate-arrow x y (+ z sz) 'z)
            (iterate-axis (+ x ps ar) (- y ar) (- z ar) (+ x sx) (+ y ar) (+ z ar) 'x)
            (iterate-axis (- x ar) (+ y ps ar) (- z ar) (+ x ar) (+ y sy) (+ z ar) 'y)
            (iterate-axis (- x ar) (- y ar) (+ z ps ar) (+ x ar) (+ y ar) (+ z sz) 'z))))))
  
  
  (method (widget-contact h v)
    (let ((world (current-world)))
      (let ((camera (current-camera))
            (pos (get-position~ (first-target~ world)))
            (part (get-widget-part~ world)))
        (receive (position direction) (screen->ray~ camera h v)
          (receive (vertex normal) (case part
                                     ((plane-x) (ray-plane-intersection~ world position direction #t 'x (vertex-x pos)))
                                     ((plane-z) (ray-plane-intersection~ world position direction #t 'z (vertex-z pos)))
                                     ((x z plane-y) (ray-plane-intersection~ world position direction #t 'y (vertex-y pos)))
                                     ((y) (let ((sight (get-sight~ camera)))
                                            (if (> (vertex-z sight) (* 3. (vertex-x sight)))
                                                (ray-plane-intersection~ world position direction #t 'x (vertex-x pos))
                                              (ray-plane-intersection~ world position direction #t 'z (vertex-z pos))))))
            vertex)))))
  
  
  (method override (widget-mouse-down h v)
    (let ((world (current-world)))
      (let ((target (first-target~ world)))
        (set! contact-offset (vertex- (widget-contact h v) (get-position~ target))))))
  
  
  (method override (widget-mouse-move h v)
    (let ((world (current-world)))
      (let ((contact (widget-contact h v)))
        (when contact
          (let ((target (first-target~ world))
                (part (get-widget-part~ world)))
            (let ((new-position (vertex- contact contact-offset)))
              (let ((delta (vertex- new-position (get-position~ target))))
                (let ((projected-delta
                        (case part
                          ((plane-x plane-y plane-z) delta)
                          ((x) (vertex (vertex-x delta) 0. 0.))
                          ((y) (vertex 0. (vertex-y delta) 0.))
                          ((z) (vertex 0. 0. (vertex-z delta))))))
                  (move-target (get-target~ world) projected-delta)))))))))
  
  
  (method (move-target target delta)
    (for-each (lambda (elem)
                (move-element elem delta))
              target))
  
  
  (method (move-element elem delta)
    (let ((zone (current-zone)))
      (let ((designer (get-designer~ zone))
            (old-position (copy-vertex (get-position~ elem))))
        (let ((new-position (vertex+ old-position delta)))
          (set-property~ designer elem 'position new-position)
          (update-element~ zone elem old-position)
          (invalidate-lightmaps~ zone elem))))))


;;;
;;;; Rotater
;;;


(class Rotater extends Target-Widget


  (method override (draw-widget)
    (let ((world (current-world)))
      (let ((target (first-target~ world)))
        (let ((x (get-x~ target))
              (y (get-y~ target))
              (z (get-z~ target))
              ;; quick hack
              (sx (+ 1.5 (get-radius-x~ target)))
              (sy (+ 1.5 (get-radius-y~ target)))
              (sz (+ 1.5 (get-radius-z~ target)))
              (radius (+ .5 (get-radius~ target))))
          (glLineWidth 2.)
          (glDisable GL_LIGHTING)
          (glDisable GL_DEPTH_TEST)
          @wait (
          ;; Rotate X
          (glPushMatrix)
          (glTranslatef x y z)
          (glRotatef 90.0 0.0 1.0 0.0)
          (gl-segment-circle {Point 0 0} radius {Color Red} 100)
          (glPopMatrix)
          
          ;; Rotate Y
          (glPushMatrix)
          (glTranslatef x y z)
          (glRotatef 90.0 1.0 0.0 0.0)
          (gl-segment-circle {Point 0 0} radius {Color Green} 100)
          (glPopMatrix)
          
          ;; Rotate Z
          (glPushMatrix)
          (glTranslatef x y z)
          (glRotatef 90.0 0.0 0.0 1.0)
          (gl-segment-circle {Point 0 0} radius {Color Blue} 100)
          (glPopMatrix))
          
          ;; quick hack
          (glBegin GL_LINES)
          
          ;; Axis X
          (colorize-dye 'x red-dye)
          (glVertex3f (+ x 0.0) y (+ z 0.0))
          (glVertex3f (+ x  sx) y (+ z 0.0))
          
          ;; Axis Y
          (colorize-dye 'y green-dye)
          (glVertex3f (+ x 0.0) (+ y 0.0) z)
          (glVertex3f (+ x 0.0) (+ y  sy) z)
          
          ;; Axis Z
          (colorize-dye 'z blue-dye)
          (glVertex3f (+ x 0.0) y (+ z 0.0))
          (glVertex3f (+ x 0.0) y (+ z  sz))
          (glEnd)
          ;(glEnable GL_LIGHTING)
          (glLineWidth 1.)
          
          ;; Sphere X
          (glPushMatrix)
          (glTranslatef (+ x sx) y z)
          (glRotatef 90.0 0.0 1.0 0.0)
          (glScalef 0.1 0.1 0.1)
          (colorize-dye 'x red-dye)
          (gl-sphere 1. 26 52)
          (glPopMatrix)
          
          ;; Sphere Y
          (glPushMatrix)
          (glTranslatef x (+ y sy) z)
          (glRotatef -90.0 1.0 0.0 0.0)
          (glScalef 0.1 0.1 0.1)
          (colorize-dye 'y green-dye)
          (gl-sphere 1. 26 52)
          (glPopMatrix)
          
          ;; Sphere Z
          (glPushMatrix)
          (glTranslatef x y (+ z sz))
          (glRotatef -90.0 0.0 0.0 1.0)
          (glScalef 0.1 0.1 0.1)
          (colorize-dye 'z blue-dye)
          (gl-sphere 1. 26 52)
          (glPopMatrix)
          
          (glEnable GL_LIGHTING)
          (glEnable GL_DEPTH_TEST)
          (glLineWidth 1.)))))
  
  
  ;; quick hack
  (method override (iterate-polygons proc)
    (let ((world (current-world)))
      (let ((target (first-target~ world)))
        (when (and target (target-moveable?~ target))
          (let ((x (get-x~ target))
                (y (get-y~ target))
                (z (get-z~ target))
                (sx (+ 1.5 (get-radius-x~ target)))
                (sy (+ 1.5 (get-radius-y~ target)))
                (sz (+ 1.5 (get-radius-z~ target)))
                (cuboid (make-cuboid))
                (cr .1))
            (define (iterate x y z part)
              (cuboid-init! cuboid (- x cr) (- y cr) (- z cr) (+ x cr) (+ y cr) (+ z cr))
              (iterate-cuboid-quads cuboid (cons self part) proc))
            
            (iterate x y z 'global)
            (iterate (+ x sx) y z 'x)
            (iterate x (+ y sy) z 'y)
            (iterate x y (+ z sz) 'z))))))
  
  
  ;; quick hack
  (method override (widget-mouse-down h v)
    (set! last-point (new Point h v)))
  
  
  ;; quick hack
  (method override (widget-mouse-move h v)
    (let ((world (current-world)))
      (let ((target (get-target~ world))
            (part (get-widget-part~ world)))
        (let ((delta (- h (get-h~ last-point))))
          (set! last-point (new Point h v))
          (rotate-target target delta part)))))
  
  
  (method (rotate-target target delta part)
    (for-each (lambda (elem)
                (rotate-element elem delta part))
              target))
  
  
  (method (rotate-element elem delta part)
    (let ((zone (current-zone)))
      (let ((designer (get-designer~ zone))
            (d (cast <fl> delta)))
        (let ((inc (* d (/ PI/8 2.))))
          (case part
            ((x) (set-lookat~ elem (rotate-lookat& (get-lookat~ elem) inc (get-sight~ (get-lookat~ elem)))))
            ((y) (set-lookat~ elem (rotate-lookat& (get-lookat~ elem) inc (get-up~ (get-lookat~ elem)))))
            ((z) (set-lookat~ elem (rotate-lookat& (get-lookat~ elem) inc (get-right~ (get-lookat~ elem))))))
          (set-property~ designer elem 'lookat (get-lookat~ elem)))))))


;;;
;;;; Scaler
;;;


(class Scaler extends Target-Widget


  (method override (draw-widget)
    (let ((world (current-world)))
      (let ((target (first-target~ world)))
        (let ((x (get-x~ target))
              (y (get-y~ target))
              (z (get-z~ target))
              (sx (+ 1.5 (get-radius-x~ target)))
              (sy (+ 1.5 (get-radius-y~ target)))
              (sz (+ 1.5 (get-radius-z~ target))))
          (glLineWidth 2.)
          (glDisable GL_LIGHTING)
          (glDisable GL_DEPTH_TEST)
          (glBegin GL_LINES)
          
          ;; Axis X
          (colorize-dye 'x red-dye)
          (glVertex3f (+ x 0.0) y (+ z 0.0))
          (glVertex3f (+ x  sx) y (+ z 0.0))
          
          ;; Axis Y
          (colorize-dye 'y green-dye)
          (glVertex3f (+ x 0.0) (+ y 0.0) z)
          (glVertex3f (+ x 0.0) (+ y  sy) z)
          
          ;; Axis Z
          (colorize-dye 'z blue-dye)
          (glVertex3f (+ x 0.0) y (+ z 0.0))
          (glVertex3f (+ x 0.0) y (+ z  sz))
          (glEnd)
          (glLineWidth 1.)
          
          ;; Sphere X
          (glPushMatrix)
          (glTranslatef (+ x sx) y z)
          (glRotatef 90.0 0.0 1.0 0.0)
          (glScalef 0.1 0.1 0.1)
          (colorize-dye 'x red-dye)
          (gl-sphere 1. 26 52)
          (glPopMatrix)
          
          ;; Sphere Y
          (glPushMatrix)
          (glTranslatef x (+ y sy) z)
          (glRotatef -90.0 1.0 0.0 0.0)
          (glScalef 0.1 0.1 0.1)
          (colorize-dye 'y green-dye)
          (gl-sphere 1. 26 52)
          (glPopMatrix)
          
          ;; Sphere Z
          (glPushMatrix)
          (glTranslatef x y (+ z sz))
          (glRotatef -90.0 0.0 0.0 1.0)
          (glScalef 0.1 0.1 0.1)
          (colorize-dye 'z blue-dye)
          (gl-sphere 1. 26 52)
          (glPopMatrix)
          
          ;; Sphere Global
          (glPushMatrix)
          (glTranslatef x y z)
          (glRotatef 90.0 0.0 1.0 0.0)
          (glScalef 0.15 0.15 0.15)
          (colorize-dye 'global (dye .5 .5 .5 1.))
          (gl-sphere 1. 26 52)
          (glPopMatrix)
          (glEnable GL_LIGHTING)
          (glEnable GL_DEPTH_TEST)))))
  
  
  (method override (iterate-polygons proc)
    (let ((world (current-world)))
      (let ((target (first-target~ world)))
        (when (and target (target-moveable?~ target))
          (let ((x (get-x~ target))
                (y (get-y~ target))
                (z (get-z~ target))
                (sx (+ 1.5 (get-radius-x~ target)))
                (sy (+ 1.5 (get-radius-y~ target)))
                (sz (+ 1.5 (get-radius-z~ target)))
                (cuboid (make-cuboid))
                (cr .1))
            (define (iterate x y z part)
              (cuboid-init! cuboid (- x cr) (- y cr) (- z cr) (+ x cr) (+ y cr) (+ z cr))
              (iterate-cuboid-quads cuboid (cons self part) proc))
            
            (iterate x y z 'global)
            (iterate (+ x sx) y z 'x)
            (iterate x (+ y sy) z 'y)
            (iterate x y (+ z sz) 'z))))))
  
  
  (method override (widget-mouse-down h v)
    (set! last-point (new Point h v)))
  
  
  (method override (widget-mouse-move h v)
    (let ((world (current-world)))
      (let ((target (get-target~ world))
            (part (get-widget-part~ world)))
        (let ((delta (- h (get-h~ last-point))))
          (set! last-point (new Point h v))
          (scale-target target delta part)))))
  
  
  (method (scale-target target delta part)
    (for-each (lambda (elem)
                (scale-element elem delta part))
              target))
  
  
  (method (scale-element elem delta part)
    (let ((zone (current-zone)))
      (let ((designer (get-designer~ zone))
            (d (cast <fl> delta))
            (f 1.025))
        (let ((factor (if (> d 0.) f (/ f))))
          (let ((s (case part
                     ((global) (vertex factor factor factor))
                     ((x) (vertex factor 1. 1.))
                     ((y) (vertex 1. factor 1.))
                     ((z) (vertex 1. 1. factor)))))
            (set-property~ designer elem 'scale (vertex* (get-scale~ elem) s)))))))))
