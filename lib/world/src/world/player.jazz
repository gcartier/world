;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; Player
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2018
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.player jazz


(import (jazz.graphic)
        (jazz.view)
        (world)
        (world.actor)
        (world.area)
        (world.audio)
        (world.autoload)
        (world.camera)
        (world.context)
        (world.dye)
        (world.generation.block)
        (world.settings)
        (world.sound)
        (world.support))


(definition protected floor-deceleration <fl>
  .25)

(definition protected air-deceleration <fl>
  .05)


(definition protected (default-avatar)
  (let ((world (current-world)))
    (define (try path)
      (and (find-model world path error?: #f)
           path))
    
    (if (world-setting 'world.orb-avatar? #f)
        'Orb
      (or (try (if young-child?
                   "character/clockworkgnome"
                 "character/bloodelffemale"))
          'Orb))))


;; gazno quicky for test
(definition protected players <table>
  (make-table test: equal? @test-weak-values: #t))

;; open test quicky this should simply go inside the tier
(definition protected (reset-players)
  (set! players (make-table test: equal? @test-weak-values: #t)))


(definition public (register-player-no no player)
  (table-set! players no player))


(definition public (unregister-player-no no)
  @until-history-retains-players
  (table-clear players no))


(definition public (find-player-by-no no)
  (table-ref players no #f))


(class Player extends Actor
  
  
  (method meta override (package self entity)
    (error "Players should not be packaged"))
  
  
  (method meta override (unpackage self info)
    (error "Players should not be unpackaged"))
  
  
  (property me?           <bool>   initialize #t  accessors generate)
  (property avatar        <object> initialize #f  getter generate setter explicit)
  
  (slot no                <object> initialize #f  accessors generate)
  (slot aggroed-creatures <list>   initialize '() accessors generate)
  (slot eating            <fl+>    initialize #f  accessors generate)
  (slot eating-ticks      <fx+>    initialize #f  accessors generate)
  (slot controlled        <object> initialize #f  accessors generate)
  
  
  (method override (prepare self rest)
    (nextmethod self rest)
    (set-color self (dye .678 .047 .902 1.))
    (update-model self))
  
  
  (method override (finish self rest)
    (nextmethod self rest)
    (set! motion 'run))
  
  
  (method override (setup-id self)
    )
  
  
  (method package (register-no self no)
    (set! self.no no)
    (register-player-no no self))
  
  
  (method override (setup-area-cube self)
    (unless (and (client?) (not me?))
      (set! area-cube (new Area-Cube 7))))
  
  
  (method override (update-area-cube self)
    (assert area-cube
      (nextmethod self)))
    
  
  (method override (update-matrix self)
    (nextmethod self)
    (when (window?)
      (if me?
          (update-3d-audibles position (get-sight lookat))
        (let ((output (find-output (current-audio) id)))
          (when output
            (update-3d-output output position))))))

  
  (method override (simulated? self)
    (not me?))
  
  
  (method override (task-name self)
    'bot)
  
  
  (method package (set-avatar self avat)
    (set! avatar avat)
    (update-model self))
  
  
  (method package (update-model self)
    (let ((world (current-world))
          (zone (current-zone)))
      (let ((new-model (if avatar
                           (if (dye? avatar)
                               (begin
                                 (set-color self avatar)
                                 'Orb)
                             avatar)
                         (default-avatar))))
        (when (neq? new-model model)
          (free-morphing self)
          (set-model self new-model)
          ;; reset defaults
          (set-scaling self 1.)
          (set-animate? self #f)
          (when (string? new-model)
            (metadata-install self)
            (when (window?)
              (setup-morphing self)
              (set-animate? self #t))
            (set-orientation self 'vertical))))))
  
  
  (method package (player-camera self)
    (find-type self Camera))
  
  
  (method override (effective-pumps self)
    (let ((model (cache-model self)))
      (or (and block-pumps? (get-block-pumps model))
          (get-pumps model))))
  
  
  (method override (walk-speed self)
    (/ (run-speed self) 3.))
  
  
  (method override (run-speed self)
    8.)
  
  
  (method override (admin-me? self)
    (and (admin?)
         me?))
  
  
  (method package (unaggro self)
    (for-each (lambda (creature)
                (set-aggro-target creature #f))
              aggroed-creatures)
    (set! aggroed-creatures '()))
  
  
  (method package (verify-water self)
    (let ((block (block-at-center self)))
      (let ((liquid? (and block (get-liquid-cube? (id->block block)))))
        (cond ((and liquid? (not water?))
               (enter-water self (memq? block '(10 11)))
               (play-ambience (current-ambience) "ambience/water/Underwater"))
              ((and (not liquid?) water?)
               (change-ambience (current-ambience) error?: #f)
               (exit-water self))))))
  
  
  (method override (print self output readably)
    (print-unreadable self output
      (lambda (output)
        (format output "{a} {a}" name position))))
  
  
  (method override (is-player? self)
    #t)
  
  
  ;;;
  ;;;; History
  ;;;
  
  
  (method override (history-draw-trail? self)
    #t)
  
  
  ;;;
  ;;;; Actions
  ;;;
  
  
  (method override (wound self inflictor factor (amount #f))
    ;; fix me at the moment firing in multiplayer will almost always kill oneself
    (unless (eq? inflictor self)
      (let ((critical? (and (not amount) (> (random-real) .8))))
        (damage self (or amount (attack-amount inflictor factor (wound-amount self critical?)))
                critical?))))
  
  
  (method override (damage self amount critical?)
    (when (server?)
      (world.changes:damage-change self amount critical?))
    (nextmethod self amount critical?)
    (let ((interface (current-interface+)))
      (when (and interface me?)
        (let ((panel (child interface 'combat)))
          (set-visible? panel #t)
          (invalidate-view panel))
        (let ((panel (child interface 'character)))
          (when (get-visible? panel)
            (view-health panel))
          (damage-armor panel critical?))))
    (stop-eating self))
  
  
  (method override (attack self kind)
    (let ((interface (current-interface+)))
      (when (and interface me?)
        (let ((panel (child interface 'character)))
          (case kind
            ((bullet) (damage-weapon panel))
            ((arrow) (damage-bow panel))))))
    (stop-eating self))
  
  
  (method override (wound-amount self critical?)
    (/ (nextmethod self critical?) armor-factor))
  
  
  (method override (die self)
    (let ((interface (current-interface+))
          (history (current-history))
          (world (current-world))
          (zone (current-zone))
          (tier (current-tier)))
      (when (and me? (not (get-paused? history)))
        (sleep .5))
      (play-3d-sound-if (death-sound self) position)
      (display-message world (format "R.I.P. {a}" (or name (anonymous tier))) color: {Color Orange})
      (unaggro self)
      (set-life self 100.)
      (set-alive? self #t)
      (set-lava? self #f)
      (set-water? self #f)
      (when (and interface me?)
        (invalidate-view (child interface 'combat)))
      (resurrect-player zone self)
      (update-compass world)
      (when me?
        (eye-behind-player world)
        (follow-player world))))
  
  
  (method override (resurrect self)
    (nextmethod self)
    (update-compass (current-world)))
  
  
  (method (stop-eating self)
    (set! eating #f)
    (set! eating-ticks #f))
  
  
  (method package (control self actor)
    (let ((world (current-world)))
      (set! controlled actor)
      (eye-behind-actor world actor)
      (follow-actor world actor)))
  
  
  (method package (relinquish-control self)
    (let ((world (current-world)))
      (set! controlled #f)
      (eye-behind-player world)
      (follow-player world)))
  
  
  (method package (effective-controlled self)
    (or controlled self))
  
  
  (method override (tick-slice self)
    .04)
  
  
  (method override (tick-action self commands time elapse)
    (unless (= elapse 0.)
      (tick-actor (effective-controlled self) commands time elapse #t 'slide)))
  
  
  (method override (hit self collisions)
    )
  
  
  (method package (move-backward self commands)
    (move-backward commands))
  
  
  (method package (move-forward self commands)
    (move-forward commands))
  
  
  (method package (sprint-forward self commands)
    (sprint-forward commands))
  
  
  (method package (sprint-backward self commands)
    (sprint-backward commands))
  
  
  (method package (blink-forward self commands)
    (blink-forward commands))
  
  
  (method package (blink-backward self commands)
    (blink-backward commands))
  
  
  (method package (move-left self commands)
    (move-left commands))
  
  
  (method package (move-right self commands)
    (move-right commands))
  
  
  (method package (move-up self commands)
    (move-up commands))
  
  
  (method package (move-down self commands)
    (move-down commands))
  
  
  (method package (rotate-left self commands)
    (rotate-left commands))
  
  
  (method package (rotate-right self commands)
    (rotate-right commands))
  
  
  (method package (space self commands)
    (jump self commands))
  
  
  (method package (jump self commands)
    (jump commands))))
