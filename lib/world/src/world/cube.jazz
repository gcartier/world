;;;==============
;;;  JazzScheme
;;;==============
;;;
;;;; Cubes
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2013
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.cube jazz


(import (jazz.geometry)
        (jazz.graphic)
        (jazz.graphic.opengl.glew)
        (jazz.io)
        (jazz.jml)
        (jazz.library)
        (jazz.literals)
        (jazz.media)
        (jazz.network)
        (jazz.platform)
        (jazz.platform.cairo)
        (jazz.runtime)
        (jazz.system)
        (jazz.ui)
        (jazz.ui.dialog)
        (jazz.ui.window)
        (time)
        (world)
        (world.autoload)
        (world.block)
        (world.draw)
        (world.dye)
        (world.element)
        (world.face)
        (world.foreign)
        (world.geometry)
        (world.model)
        (world.object)
        (world.quad)
        (world.syntax (phase syntax))
        (world.texture)
        (world.triangle))


;;;
;;;; Cube
;;;


(class Cube extends Block
  
  
  (property left-image   initialize #f accessors generate)
  (property right-image  initialize #f accessors generate)
  (property bottom-image initialize #f accessors generate)
  (property top-image    initialize #f accessors generate)
  (property back-image   initialize #f accessors generate)
  (property front-image  initialize #f accessors generate)
  
  
  (method override (prepare rest)
    (nextmethod rest)
    (set! path 'Cube)
    (set-color (dye .525 .321 .004 1.)))
  
  
  (method override (element-radiuses)
    (vertex .5 .5 .5))
  
  
  ;;;
  ;;;; Faces
  ;;;
  
  
  (method override (element-faces)
    (let ((world (current-world))
          (bounds (make-cuboid&)))
      (get-bounds! bounds)
      (let ((x (get-x))
            (y (get-y))
            (z (get-z))
            (left (cuboid-left bounds))
            (right (cuboid-right bounds))
            (bottom (cuboid-bottom bounds))
            (top (cuboid-top bounds))
            (back (cuboid-back bounds))
            (front (cuboid-front bounds))
            (default-image (get-default-image~ world)))
        (list
          ;; front face
          (let ((image (or front-image default-image)))
            (let ((uv (image-coordinates image)))
              (let ((tl (uv-left uv))
                    (tt (uv-top uv))
                    (tr (uv-right uv))
                    (tb (uv-bottom uv))
                    (texture-depth (uv-depth uv)))
                (make-face image
                           (f32vector tl tt tl tb tr tb tr tt)
                           texture-depth
                           (make-quad self
                                      (vertex left top front) (vertex left bottom front) (vertex right bottom front) (vertex right top front))))))
          ;; back face
          (let ((image (or back-image default-image)))
            (let ((uv (image-coordinates image)))
              (let ((tl (uv-left uv))
                    (tt (uv-top uv))
                    (tr (uv-right uv))
                    (tb (uv-bottom uv))
                    (texture-depth (uv-depth uv)))
                (make-face image
                           (f32vector tr tt tr tb tl tb tl tt)
                           texture-depth
                           (make-quad self
                                      (vertex right top back) (vertex right bottom back) (vertex left bottom back) (vertex left top back))))))
          ;; left face
          (let ((image (or left-image default-image)))
            (let ((uv (image-coordinates image)))
              (let ((tl (uv-left uv))
                    (tt (uv-top uv))
                    (tr (uv-right uv))
                    (tb (uv-bottom uv))
                    (texture-depth (uv-depth uv)))
                (make-face image
                           (f32vector tl tt tl tb tr tb tr tt)
                           texture-depth
                           (make-quad self
                                      (vertex left top back) (vertex left bottom back) (vertex left bottom front) (vertex left top front))))))
          ;; right face
          (let ((image (or right-image default-image)))
            (let ((uv (image-coordinates image)))
              (let ((tl (uv-left uv))
                    (tt (uv-top uv))
                    (tr (uv-right uv))
                    (tb (uv-bottom uv))
                    (texture-depth (uv-depth uv)))
                (make-face image
                           (f32vector tl tt tl tb tr tb tr tt)
                           texture-depth
                           (make-quad self
                                      (vertex right top front) (vertex right bottom front) (vertex right bottom back) (vertex right top back))))))
          ;; top face
          (let ((image (or top-image default-image)))
            (let ((uv (image-coordinates image)))
              (let ((tl (uv-left uv))
                    (tt (uv-top uv))
                    (tr (uv-right uv))
                    (tb (uv-bottom uv))
                    (texture-depth (uv-depth uv)))
                (make-face image
                           (f32vector tl tb tl tt tr tt tr tb)
                           texture-depth
                           (make-quad self
                                      (vertex left top back) (vertex left top front) (vertex right top front) (vertex right top back))))))
          ;; bottom face
          (let ((image (or bottom-image default-image)))
            (let ((uv (image-coordinates image)))
              (let ((tl (uv-left uv))
                    (tt (uv-top uv))
                    (tr (uv-right uv))
                    (tb (uv-bottom uv))
                    (texture-depth (uv-depth uv)))
                (make-face image
                           (f32vector tl tt tl tb tr tb tr tt)
                           texture-depth
                           (make-quad self
                                      (vertex left bottom front) (vertex left bottom back) (vertex right bottom back) (vertex right bottom front))))))))))
  
  
  (method override (update-face-texture face face-rank texture)
    (let ((zone (current-zone)))
      (let ((designer (get-designer~ zone)))
        (case face-rank
          ((0) (set-property~ designer self 'front-image texture))
          ((1) (set-property~ designer self 'back-image texture))
          ((2) (set-property~ designer self 'left-image texture))
          ((3) (set-property~ designer self 'right-image texture))
          ((4) (set-property~ designer self 'top-image texture))
          ((5) (set-property~ designer self 'bottom-image texture))))))))
