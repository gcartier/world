;;;==============
;;;  JazzScheme
;;;==============
;;;
;;;; Commands
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2013
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.commands jazz


(import (world.serialization))


(class Commands extends Object
  
  
  (slot move-left?      <bool>   initialize #f getter generate)
  (slot move-right?     <bool>   initialize #f getter generate)
  (slot move-down?      <bool>   initialize #f getter generate)
  (slot move-up?        <bool>   initialize #f getter generate)
  (slot blink-forward?  <bool>   initialize #f getter generate)
  (slot blink-backward? <bool>   initialize #f getter generate)
  (slot strafe-left?    <bool>   initialize #f getter generate)
  (slot strafe-right?   <bool>   initialize #f getter generate)
  (slot strafe-up?      <bool>   initialize #f getter generate)
  (slot strafe-down?    <bool>   initialize #f getter generate)
  (slot rotate-left?    <bool>   initialize #f getter generate)
  (slot rotate-right?   <bool>   initialize #f getter generate)
  (slot jump?           <bool>   initialize #f getter generate)
  (slot actions         <object> initialize (new-queue) getter generate)
  (slot last-no         <object> initialize #f getter generate)
  (slot command?        <bool>   initialize #f getter generate)
  (slot modified?       <bool>   initialize #f getter generate)
  
  
  (method override (print output readably)
    (print-unreadable self output
      (lambda (output)
        (format output "{l}" (->symbolic)))))
  
  
  (method protected (->symbolic)
    (let ((queue (new-queue)))
      (define (add flag name)
        (when flag
          (enqueue queue name)))
      
      (add move-left? 'move-left)
      (add move-right? 'move-right)
      (add move-down? 'move-down)
      (add move-up? 'move-up)
      (add strafe-left? 'strafe-left)
      (add strafe-right? 'strafe-right)
      (add strafe-up? 'strafe-up)
      (add strafe-down? 'strafe-down)
      (add rotate-left? 'rotate-left)
      (add rotate-right? 'rotate-right)
      (add jump? 'jump)
      
      (queue-list queue)))
  
  
  (method meta override (marshall-object obj)
    ;; quicky for test
    (complete~ obj)
    (serialize-object (class-of obj)
                      (vector (serialize (get-move-left?~ obj))
                              (serialize (get-move-right?~ obj))
                              (serialize (get-move-down?~ obj))
                              (serialize (get-move-up?~ obj))
                              (serialize (get-strafe-left?~ obj))
                              (serialize (get-strafe-right?~ obj))
                              (serialize (get-strafe-up?~ obj))
                              (serialize (get-strafe-down?~ obj))
                              (serialize (get-rotate-left?~ obj))
                              (serialize (get-rotate-right?~ obj))
                              (serialize (get-jump?~ obj))
                              (let ((actions (get-actions~ obj)))
                                (and actions (map serialize actions)))
                              (serialize (get-last-no~ obj))
                              (serialize (get-command?~ obj)))))
  
  
  (method meta override (unmarshall-object content)
    (bind-vector (move-left? move-right? move-down? move-up? strafe-left? strafe-right? strafe-up? strafe-down? rotate-left? rotate-right? jump? actions last-no command?) content
      (allocate self
        (deserialize move-left?)
        (deserialize move-right?)
        (deserialize move-down?)
        (deserialize move-up?)
        (deserialize strafe-left?)
        (deserialize strafe-right?)
        (deserialize strafe-up?)
        (deserialize strafe-down?)
        (deserialize rotate-left?)
        (deserialize rotate-right?)
        (deserialize jump?)
        (and actions (map deserialize actions))
        (deserialize last-no)
        (deserialize command?)
        #f)))
  
  
  (method public (move-left)
    (set! move-left? #t)
    (set! command? #t)
    (set! modified? #t))
  
  (method public (move-right)
    (set! move-right? #t)
    (set! command? #t)
    (set! modified? #t))
  
  (method public (move-down)
    (set! move-down? #t)
    (set! command? #t)
    (set! modified? #t))
  
  (method public (move-up)
    (set! move-up? #t)
    (set! command? #t)
    (set! modified? #t))
  
  
  (method public (blink-forward)
    (set! blink-forward? #t)
    (set! command? #t)
    (set! modified? #t))
  
  (method public (blink-backward)
    (set! blink-backward? #t)
    (set! command? #t)
    (set! modified? #t))
  
  
  (method public (strafe-left)
    (set! strafe-left? #t)
    (set! command? #t)
    (set! modified? #t))
  
  (method public (strafe-right)
    (set! strafe-right? #t)
    (set! command? #t)
    (set! modified? #t))
  
  (method public (strafe-up)
    (set! strafe-up? #t)
    (set! command? #t)
    (set! modified? #t))
  
  (method public (strafe-down)
    (set! strafe-down? #t)
    (set! command? #t)
    (set! modified? #t))
  
  
  (method public (rotate-left)
    (set! rotate-left? #t)
    (set! command? #t)
    (set! modified? #t))
  
  (method public (rotate-right)
    (set! rotate-right? #t)
    (set! command? #t)
    (set! modified? #t))
  
  
  (method public (jump)
    (set! jump? #t)
    (set! command? #t)
    (set! modified? #t))
  
  
  (method public (add-action name arguments)
    (enqueue actions (cons name arguments))
    (set! modified? #t))
  
  
  (method public (enqueue-action action)
    (enqueue actions action)
    (set! modified? #t))
  
  
  (method public (set-last-no no)
    (set! last-no no))
  
  
  (method public (complete)
    (when (and modified? (is? actions Queue))
      (set! actions (queue-list actions))))
  
  
  (method (serialize)
    (vector move-left?
            move-right?
            move-down?
            move-up?
            strafe-left?
            strafe-right?
            strafe-up?
            strafe-down?
            rotate-left?
            rotate-right?
            jump?
            actions
            last-no
            command?))
  
  
  (method (deserialize vec)
    (set! move-left?    (vector-ref vec 0))
    (set! move-right?   (vector-ref vec 1))
    (set! move-down?    (vector-ref vec 2))
    (set! move-up?      (vector-ref vec 3))
    (set! strafe-left?  (vector-ref vec 4))
    (set! strafe-right? (vector-ref vec 5))
    (set! strafe-up?    (vector-ref vec 6))
    (set! strafe-down?  (vector-ref vec 7))
    (set! rotate-left?  (vector-ref vec 8))
    (set! rotate-right? (vector-ref vec 9))
    (set! jump?         (vector-ref vec 10))
    (set! actions       (vector-ref vec 11))
    (set! last-no       (vector-ref vec 12))
    (set! command?      (vector-ref vec 13))
    (set! modified?     #t)))


;;;
;;;; Serialization
;;;


(definition public (serialize-commands commands)
  (serialize~ commands))


(definition public (deserialize-commands vec)
  (let ((commands (new Commands)))
    (deserialize~ commands vec)
    commands)))
