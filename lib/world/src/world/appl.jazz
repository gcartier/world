;;;==============
;;;  JazzScheme
;;;==============
;;;
;;;; World Application
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.appl jazz


(import (jazz.debuggee)
        (jazz.graphic)
        (jazz.ide.login)
        (jazz.io)
        (jazz.jml)
        (jazz.jrm)
        (jazz.library)
        (jazz.locale)
        (jazz.system)
        (jazz.system.application)
        (jazz.ui)
        (jazz.ui.view)
        (jazz.ui.window)
        (jazz.version)
        (world)
        (world.autoload)
        (world.player)
        (world.settings)
        (world.syntax (phase syntax))
        (world.client.configuration)
        (world.client.window)
        (world.window))


(class World-Application extends Application
  
  
  (method public virtual abstract (tier))
  (method public virtual abstract (server-side?))
  (method public virtual abstract (client-side?))
  (method public virtual abstract (get-world-server))
  (method public virtual abstract (get-world-client))
  (method public virtual abstract (enter-zone))

  
  ;;;
  ;;;; Name
  ;;;
  
  
  (method protected virtual (effective-player-name)
    )
  
  
  ;;;
  ;;;; Shortcuts 	
  ;;;
  
  
  (method override (dispatch-shortcut shortcut)
    (if (and (get-focus)
             (let ((modifiers (get-modifiers~ shortcut))
                   (key (get-key~ shortcut)))
               (and (or (null? modifiers)
                        (equal? modifiers '(:shift)))
                    (char? key)
                    (word-constituent? key))))
        #f
      (if (let ((world (current-world)))
            (or (not world)
                (not (process-shortcut~ world shortcut))))
          (nextmethod shortcut)
        #t)))
  
  
  ;;;
  ;;;; Activation
  ;;;
  
  
  (method override (deactivate)
    (update-timer #f)
    (nextmethod))
  
  
  (method override (activate)
    (update-timer #t)
    (nextmethod))
  
  
  (cond-expand
    (windows
     (method (update-timer active?)
       (let ((window (current-world-window+)))
         (when window
           (if active?
               (set-timer~ window 0 10)
             (set-timer~ window 0 33)
             ;; need to understand why having two worlds at the same time kills the FPS
             @w
             (kill-timer~ window 0))))))
    (else
     (method (update-timer active?)
       )))
  
  
  ;;;
  ;;;; Toplevel
  ;;;
  
  
  (method override (show-toplevel)
    )))
