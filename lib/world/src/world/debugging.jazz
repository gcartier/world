;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; World Debugging
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2018
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.debugging jazz


(definition public debugging-priority <fl>
  1000.)


(definition package (start-debugging)
  (let ((thread (new-thread run-debugging 'debugging)))
    (thread-base-priority-set! thread debugging-priority)
    (thread-start! thread)))


(definition (run-debugging)
  (declare (proper-tail-calls))
  (thread-sleep! +inf.0)
  @wait-this-can-detect-deadlock-while-we-are-generating-snapshot
  (let ((task-mutex world.task:task-mutex))
    (let (loop)
      (sleep 2)
      (if (not (mutex-lock! task-mutex 10))
          (error "Task mutex deadlock detected")
        (mutex-unlock! task-mutex)
        (loop))))))
