;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; World Script Entities
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2016
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.script.entity jazz


(import (jazz.io)
        (world)
        (world.autoload)
        (world.entity)
        (world.scripter)
        (world.scripting)
        (world.syntax (phase syntax)))


(definition protected running-scripts
  (make-table test: equal?))


(definition public (register-script info)
  (or (table-ref running-scripts info #f)
      (let ((entity (new Script-Entity)))
        (new Script parent: entity text: (load-script-text info))
        (table-set! running-scripts info entity)
        entity)))


(definition public (launch-script info)
  (let ((entity (register-script info)))
    (let ((script (get-script~ entity)))
      (run-task~ entity script))))


(definition public (save-asset-script info entity)
  (bind (dir . path) info
    (let ((file (new-file~ dir path)))
      (call-with-output-file (path-settings file)
        (lambda (output)
          (display (get-text~ (get-script~ entity)) output))))))


;;;
;;;; Script-Entity
;;;


(class Script-Entity extends Entity
  
  
  (method override (task-name)
    'script)
  
  
  (method override (virtual?)
    #t)))
