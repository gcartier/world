;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; Script Actor
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2016
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.script.actor jazz


(import (world)
        (world.actor)
        (world.audio)
        (world.autoload)
        (world.commands)
        (world.geometry)
        (world.scripting)
        (world.syntax (phase syntax)))


;;;
;;;; Sound
;;;


(definition public bark
  "sound/random/dog_barking")


(definition public (sound path (volume: volume #f))
  (when sounds?
    (let ((sound (cache-stream-sound path)))
      (unless (playing?~ sound)
        (when volume
          (set-volume~ sound volume))
        (play~ sound)))))


;;;
;;;; Actor
;;;


(definition public (current-actor)
  (car (current-event)))


(definition public (lookat-horizon dir)
  (horizon-lookat (vertex-normalize& (vertex& (vertex-x dir) 0. (vertex-z dir)))))


(definition public (near-player? (actor #f) (distance #f))
  (let ((actor (or actor (current-actor)))
        (distance (or distance 5.)))
    (<= (vertex-distance (get-position~ actor) (get-position~ (current-me))) distance)))


(definition public (lookat-player (actor #f))
  (let ((actor (or actor (current-actor))))
    (let ((dir (vertex- (get-position~ (current-me)) (get-position~ actor))))
      (set-lookat actor (lookat-horizon dir)))))


(definition public stay-commands
  (new Commands))

(definition public move-commands
  (let ((commands (new Commands)))
    (move-forward~ commands)
    commands))

(definition public jump-commands
  (let ((commands (new Commands)))
    (jump~ commands)
    commands))


(definition public (stay)
  (perform stay-commands))

(definition public (move)
  (perform move-commands))

(definition public (jump)
  (perform jump-commands))


(definition public (get-position element)
  (get-position~ element))


(definition public (set-lookat element lookat)
  (set-lookat~ element lookat))


(definition public (set-tick-handler actor handler)
  (set-script-tick~ actor handler))


(definition public (perform commands)
  (assert (is? commands Commands))
  (bind (actor time elapse exit) (current-event)
    (tick-actor~ actor commands time elapse exit #t 'slide))))
