;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; World Tiers
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2016
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.tier jazz


(import (jazz.component)
        (jazz.jrm)
        (jazz.jrm.protocol)
        (world)
        (world.assets)
        (world.autoload)
        (world.history)
        (world.id)
        (world.log)
        (world.settings)
        (world.syntax (phase syntax))
        (world.task))


(definition protected disconnect-marker
  '<<<disconnect>>>)


;;;
;;;; Tier
;;;


(class Tier extends Object
  
  
  (slot directory getter generate)
  (slot assets    getter generate)
  
  
  ;; called before zone creation
  (method override (initialize dir)
    (set! directory dir))
  
  
  (method (script-file)
    (new-file~ directory "script.jazz"))
  
  
  ;; called during zone creation
  (method protected virtual (enter)
    )
  
  
  (method protected virtual (shutdown)
    )
  
  
  (method (simulate-protocol setting)
    (set-simulated-protocol (world-setting setting #f)))
  
  
  ;;;
  ;;;; Register
  ;;;
  
  
  (method protected virtual (tier-literal->id literal)
    )
  
  
  (method protected virtual (tier-id->literal id)
    )
  
  
  ;;;
  ;;;; Player
  ;;;
  
  
  (method protected virtual (setup-me)
    )
  
  
  (method protected virtual (save-me)
    )
  
  
  (method protected virtual (player-file)
    )
  
  
  (method (setup-current-me)
    (let ((zone (current-zone)))
      (let ((file (player-file)))
        (let ((player (instantiate~ (read-form file))))
          (set-current-me player)))))
  
  
  (method (save-current-me)
    (let ((world (current-world))
          (me (current-me)))
      (let ((designer (new Former form: (get-form~ me) reference: me)))
        (define (save-camera)
          (let ((eye (get-eye~ world))
                (camera (player-camera~ me)))
            (set-property~ designer camera 'position (get-position~ eye))
            (set-property~ designer camera 'lookat (get-lookat~ eye))))
        
        (define (save-player)
          (set-property~ designer me 'position (get-position~ me))
          (set-property~ designer me 'lookat (get-lookat~ me))
          (set-property~ designer me 'avatar (get-avatar~ me))
          (set-property~ designer me 'mount (get-mount~ me)))
        
        (save-camera)
        (save-player)
        (save~ designer))))
  
  
  (method protected virtual (anonymous)
    "Me")
  
  
  ;;;
  ;;;; Players
  ;;;
  
  
  (method protected virtual (connected-player no)
    )
  
  
  (method protected virtual (connected-players)
    )
  
  
  ;;;
  ;;;; Entities
  ;;;
  
  
  (method protected virtual (retrieve-entity id)
    )
  
  
  ;;;
  ;;;; Zones
  ;;;
  
  
  (method protected virtual (available-templates)
    )
  
  
  (method protected virtual (available-zone-base from)
    )
  
  
  (method protected virtual (available-zone-base? base)
    )
  
  
  (method protected virtual (create-zone from base)
    )
  
  
  (method protected virtual (available-zones)
    )
  
  
  (method protected virtual (change-zone zone)
    )
  
  
  ;;;
  ;;;; Remote
  ;;;
  
  
  (method protected virtual (unimplemented-connected)
    )
  
  
  ;;;
  ;;;; Tile
  ;;;
  
  
  (method protected virtual (tile)
    )
  
  
  (method protected virtual (restore)
    )
  
  
  ;;;
  ;;;; Log
  ;;;
  
  
  (method protected virtual (log message)
    ))


;;;
;;;; Local
;;;


(class Local-Tier extends Tier
  
  
  (method override (initialize dir)
    (nextmethod dir)
    (let ((id (make-unique-id)))
      (set-client-id/no id (literal->id id self)))
    ;; aec quicky
    (set-remote-problem-handler #f)
    (set! assets (gather-assets 'tier (new-directory~ directory "assets"))))
  
  
  ;;;
  ;;;; Register
  ;;;
  
  
  (method override (tier-literal->id literal)
    (next-literal-id!))
  
  
  (method override (tier-id->literal id)
    (error "Unregistered id: {s}" id))
  
  
  ;;;
  ;;;; Player
  ;;;
  
  
  (method override (setup-me)
    (setup-current-me)
    (register-id~ (current-me) (make-unique-id)))
  
  
  (method override (save-me)
    (save-current-me))
  
  
  (method override (player-file)
    (let ((zone (current-zone)))
      (new-file~ (get-directory~ zone) ".player")))
  
  
  ;;;
  ;;;; Entities
  ;;;
  
  
  (method override (retrieve-entity id)
    (find-entity id))
  
  
  ;;;
  ;;;; Zones
  ;;;
  
  
  (method override (available-templates)
    (let ((world (current-world)))
      (collect-templates~ world)))
  
  
  (method override (available-zone-base from)
    (let ((world (current-world)))
      (unique-zone-base~ world from)))
  
  
  (method override (available-zone-base? base)
    (let ((world (current-world)))
      (zone-base-available?~ world base)))
  
  
  (method override (create-zone from base)
    (let ((world (current-world)))
      (when (create-new-zone~ world from base)
        (let ((zone (current-zone)))
          (teleport~ zone (find-spawnpoint~ zone))))))
  
  
  ;;;
  ;;;; Log
  ;;;
  
  
  (method override (log message)
    (when log?
      (server-log #f (current-seconds) message)))))
