;;;==============
;;;  JazzScheme
;;;==============
;;;
;;;; World Geometry Classes
;;;


(module world.geometry.classes jazz


(import (jazz.geometry)
        (jazz.graphic)
        (jazz.graphic.opengl.glew))


(proclaim (warn optimizations))


;;;
;;;; F32
;;;


(definition public F32
  Flonum)


(definition public inline (f32 x <fl>) <f32vector>
  (f32vector x))


(definition public inline (make-f32) <f32vector>
  (make-f32vector 1))


(definition public inline (f32-ref fl <f32vector>) <fl>
  (f32vector-ref fl 0))


(definition public inline (f32-set! fl <f32vector> val <fl>) <void>
  (f32vector-set! fl 0 val))


;;;
;;;; Vertex
;;;


(definition public Vertex
  F32Vector)


(definition public inline (vertex x <fl> y <fl> z <fl>) <f32vector>
  (f32vector x y z))


(definition public inline (make-vertex) <f32vector>
  (make-f32vector 3))


(definition public (copy-vertex vert <f32vector>) <f32vector>
  (let ((copy (make-vertex)))
    (vertex-copy! copy vert)
    copy))


(definition public inline (vertex-x vert <f32vector>) <fl>
  (f32vector-ref vert 0))

(definition public inline (vertex-y vert <f32vector>) <fl>
  (f32vector-ref vert 1))

(definition public inline (vertex-z vert <f32vector>) <fl>
  (f32vector-ref vert 2))


(definition public inline (vertex-x-set! vert <f32vector> x <fl>) <void>
  (f32vector-set! vert 0 x))

(definition public inline (vertex-y-set! vert <f32vector> y <fl>) <void>
  (f32vector-set! vert 1 y))

(definition public inline (vertex-z-set! vert <f32vector> z <fl>) <void>
  (f32vector-set! vert 2 z))


(definition public (vertex=? v1 <f32vector> v2 <f32vector>) <bool>
  (and (= (vertex-x v1) (vertex-x v2))
       (= (vertex-y v1) (vertex-y v2))
       (= (vertex-z v1) (vertex-z v2))))


(definition public (vertex/=? v1 <f32vector> v2 <f32vector>) <bool>
  (or (/= (vertex-x v1) (vertex-x v2))
      (/= (vertex-y v1) (vertex-y v2))
      (/= (vertex-z v1) (vertex-z v2))))


(definition public (vertex-zero? vert <f32vector>) <bool>
  (and (= (vertex-x vert) 0.)
       (= (vertex-y vert) 0.)
       (= (vertex-z vert) 0.)))


(definition public (vertex-init! vert <f32vector> x <fl> y <fl> z <fl>) <void>
  (vertex-x-set! vert x)
  (vertex-y-set! vert y)
  (vertex-z-set! vert z))


(definition public (vertex-copy! dst <f32vector> src <f32vector>) <void>
  (vertex-x-set! dst (vertex-x src))
  (vertex-y-set! dst (vertex-y src))
  (vertex-z-set! dst (vertex-z src)))


(definition public (vertex-hash vert <f32vector>)
  (fxwrap+ (eqv?-hash (vertex-x vert))
           (eqv?-hash (vertex-y vert))
           (eqv?-hash (vertex-z vert))))


(definition public (present-vertex vert)
  (format "~{Vertex {r precision: 3} {r precision: 3} {r precision: 3}}"
          (vertex-x vert)
          (vertex-y vert)
          (vertex-z vert)))


;;;
;;;; Matrix
;;;


;; 0  4  8 12
;; 1  5  9 13
;; 2  6 10 14
;; 3  7 11 15


(definition public Matrix
  F32Vector)


(definition public (matrix f0 <fl> f4 <fl> f8 <fl> f12 <fl> f1 <fl> f5 <fl> f9 <fl> f13 <fl> f2 <fl> f6 <fl> f10 <fl> f14 <fl> f3 <fl> f7 <fl> f11 <fl> f15 <fl>) <f32vector>
  (f32vector f0 f1 f2 f3 f4 f5 f6 f7 f8 f9 f10 f11 f12 f13 f14 f15))


(definition public (make-matrix) <f32vector>
  (make-f32vector 16))


(definition public (copy-matrix mat <f32vector>) <f32vector>
  (let ((copy (make-matrix)))
    (matrix-copy! copy mat)
    copy))


(definition public inline (matrix-ref mat <f32vector> ind <fx>) <fl>
  (f32vector-ref mat ind))


(definition public inline (matrix-set! mat <f32vector> ind <fx> val <object>) <void>
  (f32vector-set! mat ind val))


(definition public (matrix=? m1 <f32vector> m2 <f32vector>) <bool>
  (and (= (matrix-ref m1  0) (matrix-ref m2  0))
       (= (matrix-ref m1  1) (matrix-ref m2  1))
       (= (matrix-ref m1  2) (matrix-ref m2  2))
       (= (matrix-ref m1  3) (matrix-ref m2  3))
       (= (matrix-ref m1  4) (matrix-ref m2  4))
       (= (matrix-ref m1  5) (matrix-ref m2  5))
       (= (matrix-ref m1  6) (matrix-ref m2  6))
       (= (matrix-ref m1  7) (matrix-ref m2  7))
       (= (matrix-ref m1  8) (matrix-ref m2  8))
       (= (matrix-ref m1  9) (matrix-ref m2  9))
       (= (matrix-ref m1 10) (matrix-ref m2 10))
       (= (matrix-ref m1 11) (matrix-ref m2 11))
       (= (matrix-ref m1 12) (matrix-ref m2 12))
       (= (matrix-ref m1 13) (matrix-ref m2 13))
       (= (matrix-ref m1 14) (matrix-ref m2 14))
       (= (matrix-ref m1 15) (matrix-ref m2 15))))


(definition public (matrix-copy! dst <f32vector> src <f32vector>) <void>
  (matrix-set! dst  0 (matrix-ref src 0))
  (matrix-set! dst  1 (matrix-ref src 1))
  (matrix-set! dst  2 (matrix-ref src 2))
  (matrix-set! dst  3 (matrix-ref src 3))
  (matrix-set! dst  4 (matrix-ref src 4))
  (matrix-set! dst  5 (matrix-ref src 5))
  (matrix-set! dst  6 (matrix-ref src 6))
  (matrix-set! dst  7 (matrix-ref src 7))
  (matrix-set! dst  8 (matrix-ref src 8))
  (matrix-set! dst  9 (matrix-ref src 9))
  (matrix-set! dst 10 (matrix-ref src 10))
  (matrix-set! dst 11 (matrix-ref src 11))
  (matrix-set! dst 12 (matrix-ref src 12))
  (matrix-set! dst 13 (matrix-ref src 13))
  (matrix-set! dst 14 (matrix-ref src 14))
  (matrix-set! dst 15 (matrix-ref src 15)))


;;;
;;;; Ray
;;;


(class Ray extends Object
  
  
  (slot origin    <f32vector> initialize (make-vertex) getter generate)
  (slot direction <f32vector> initialize (make-vertex) getter generate)
  
  
  (method override (initialize orig <f32vector> dir <f32vector>)
    (set-origin orig)
    (set-direction dir))
  
  
  (method public (set-origin orig <f32vector>) <void>
    (vertex-copy! origin orig))
  
  (method public (set-direction dir <f32vector>) <void>
    (vertex-copy! direction dir)))


(definition public (make-ray orig dir)
  (new Ray orig dir))


;;;
;;;; Movement
;;;


(class Movement extends Object
  
  
  (slot origin <f32vector> initialize (make-vertex) getter generate)
  (slot vector <f32vector> initialize (make-vertex) getter generate)
  (slot normal <f32vector> initialize #f getter generate)
  (slot length <fl>        initialize #f getter generate)
  
  
  (method override (initialize orig <f32vector> vec <f32vector>)
    (set-origin orig)
    (set-vector vec))
  
  
  (method override (print output readably)
    (print-unreadable self output
      (lambda (output)
        (format output "{a} {a} {a} {a}" origin vector normal length))))
  
  
  (method public (set-origin orig <f32vector>) <void>
    (vertex-copy! origin orig))
  
  
  (method public (set-vector vec <f32vector>) <void>
    (vertex-copy! vector vec)
    (set! normal (vertex-normalize vec))
    (set! length (vertex-norm vec)))
  
  
  (method public (end)
    (vertex+ origin vector))
  
  
  (method public (end-to d)
    (vertex+ origin (vertex-scalar* normal d))))


;;;
;;;; LookAt
;;;


(class LookAt extends Object
  
  
  (slot sight <f32vector> initialize (make-vertex) getter generate)
  (slot up    <f32vector> initialize (make-vertex) getter generate)
  (slot right <f32vector> initialize (make-vertex) getter generate)
  
  
  (method override (print output readably)
    (print-unreadable self output
      (lambda (output)
        (format output "{a} {a} {a}" sight up right))))
  
  
  (method public inline (set-sight sight <f32vector>) <void>
    (vertex-copy! sight~self sight))
  
  (method public inline (set-up up <f32vector>) <void>
    (vertex-copy! up~self up))
  
  (method public inline (set-right right <f32vector>) <void>
    (vertex-copy! right~self right))
  
  
  (method public (standardize!) <void>
    (vertex-init! sight 0.0  0.0 -1.0)
    (vertex-init! up    0.0  1.0  0.0)
    (vertex-init! right 1.0  0.0  0.0))
  
  
  (method public (rotate angle <fl> vert <f32vector>) <void>
    ;; sight
    (rotate-upon! sight angle vert sight)
    (vertex-normalize! sight sight)
    ;; up
    (rotate-upon! up angle vert up)
    (vertex-normalize! up up)
    ;; right
    (rotate-upon! right angle vert right)
    (vertex-normalize! right right))
  
  
  (method public (validate-normalized) <void>
    (define (validate vert)
      (unless (near? (vertex-norm vert) 1. .0001)
        (error "Vertex {s} is not normalized" vert)))
    
    (validate sight)
    (validate up)
    (validate right)))


(definition public (make-lookat) <LookAt>
  (new LookAt))


(definition public (copy-lookat lookat <LookAt>) <LookAt>
  (let ((copy (make-lookat)))
    (set-sight~ copy (get-sight~ lookat))
    (set-up~ copy (get-up~ lookat))
    (set-right~ copy (get-right~ lookat))
    copy))


;;;
;;;; Cuboid
;;;


(class Cuboid extends Object
  
  
  (slot left   <fl> accessors generate)
  (slot bottom <fl> accessors generate)
  (slot back   <fl> accessors generate)
  (slot right  <fl> accessors generate)
  (slot top    <fl> accessors generate)
  (slot front  <fl> accessors generate)
  
  
  (method override (initialize left <fl> bottom <fl> back <fl> right <fl> top <fl> front <fl>)
    (set! left~self left)
    (set! bottom~self bottom)
    (set! back~self back)
    (set! right~self right)
    (set! top~self top)
    (set! front~self front))
  
  
  (method override (print printer readably)
    (format printer "~{{a} {r precision: 1} {r precision: 1} {r precision: 1} {r precision: 1} {r precision: 1} {r precision: 1}}"
            (category-name (class-of self))
            left
            bottom
            back
            right
            top
            front)))


;;;
;;;; Vertex Operations
;;;


(definition public (vertex+ v1 <f32vector> v2 <f32vector>) <f32vector>
  (vertex
    (+ (vertex-x v1) (vertex-x v2))
    (+ (vertex-y v1) (vertex-y v2))
    (+ (vertex-z v1) (vertex-z v2))))


(definition public (vertex+! res <f32vector> v1 <f32vector> v2 <f32vector>) <f32vector>
  (vertex-x-set! res (+ (vertex-x v1) (vertex-x v2)))
  (vertex-y-set! res (+ (vertex-y v1) (vertex-y v2)))
  (vertex-z-set! res (+ (vertex-z v1) (vertex-z v2)))
  res)


(definition public (vertex-increase! res <f32vector> v <f32vector>) <void>
  (vertex-x-set! res (+ (vertex-x res) (vertex-x v)))
  (vertex-y-set! res (+ (vertex-y res) (vertex-y v)))
  (vertex-z-set! res (+ (vertex-z res) (vertex-z v))))


(definition public (vertex- v1 <f32vector> v2 <f32vector>) <f32vector>
  (vertex
    (- (vertex-x v1) (vertex-x v2))
    (- (vertex-y v1) (vertex-y v2))
    (- (vertex-z v1) (vertex-z v2))))


(definition public (vertex-! res <f32vector> v1 <f32vector> v2 <f32vector>) <f32vector>
  (vertex-x-set! res (- (vertex-x v1) (vertex-x v2)))
  (vertex-y-set! res (- (vertex-y v1) (vertex-y v2)))
  (vertex-z-set! res (- (vertex-z v1) (vertex-z v2)))
  res)


(definition public (vertex-decrease! res <f32vector> v <f32vector>) <void>
  (vertex-x-set! res (- (vertex-x res) (vertex-x v)))
  (vertex-y-set! res (- (vertex-y res) (vertex-y v)))
  (vertex-z-set! res (- (vertex-z res) (vertex-z v))))


(definition public (vertex-negate v <f32vector>) <f32vector>
  (vertex
    (- (vertex-x v))
    (- (vertex-y v))
    (- (vertex-z v))))


(definition public (vertex-negate! res <f32vector> v <f32vector>) <f32vector>
  (vertex-x-set! res (- (vertex-x v)))
  (vertex-y-set! res (- (vertex-y v)))
  (vertex-z-set! res (- (vertex-z v)))
  res)


(definition public (vertex* v1 <f32vector> v2 <f32vector>) <f32vector>
  (vertex
    (* (vertex-x v1) (vertex-x v2))
    (* (vertex-y v1) (vertex-y v2))
    (* (vertex-z v1) (vertex-z v2))))


(definition public (vertex-scalar* v <f32vector> r <fl>) <f32vector>
  (vertex
    (* r (vertex-x v))
    (* r (vertex-y v))
    (* r (vertex-z v))))


(definition public (vertex-scalar*! res <f32vector> v <f32vector> r <fl>) <f32vector>
  (vertex-x-set! res (* r (vertex-x v)))
  (vertex-y-set! res (* r (vertex-y v)))
  (vertex-z-set! res (* r (vertex-z v)))
  res)


(definition public (vertex-norm v <f32vector>) <fl>
  (let ((x (vertex-x v))
        (y (vertex-y v))
        (z (vertex-z v)))
    (sqrt (+ (* x x)
             (* y y)
             (* z z)))))


(definition public (vertex-abs v <f32vector>) <f32vector>
  (vertex (abs (vertex-x v))
          (abs (vertex-y v))
          (abs (vertex-z v))))


(definition public (vertex-normalize v <f32vector>) <f32vector>
  (vertex-scalar* v (/ (vertex-norm v))))


(definition public (vertex-normalize-safe v <f32vector>) <f32vector>
  (let ((norm (vertex-norm v)))
    (if (= norm 0.)
        v
      (vertex-scalar* v (/ norm)))))


(definition public (vertex-normalize! res <f32vector> v <f32vector>) <f32vector>
  (vertex-scalar*! res v (/ (vertex-norm v))))


(definition public (vertex-distance v1 <f32vector> v2 <f32vector>) <fl>
  (vertex-norm (vertex- v2 v1)))


(definition public (rotate-upon angle <fl> u <f32vector> v <f32vector>) <f32vector>
  (rotate-upon! (make-vertex) angle u v))


(definition public (rotate-upon! res <f32vector> angle <fl> u <f32vector> v <f32vector>) <f32vector>
  (let ((c <fl> (cos angle))
        (s <fl> (sin angle))
        (x (vertex-x u))
        (y (vertex-y u))
        (z (vertex-z u))
        (i (vertex-x v))
        (j (vertex-y v))
        (k (vertex-z v)))
    (vertex-x-set! res (+ (* i (+ (* x x (- 1. c)) c))
                          (* j (- (* x y (- 1. c)) (* z s)))
                          (* k (+ (* x z (- 1. c)) (* y s)))))
    (vertex-y-set! res (+ (* i (+ (* y x (- 1. c)) (* z s)))
                          (* j (+ (* y y (- 1. c)) c))
                          (* k (- (* y z (- 1. c)) (* x s)))))
    (vertex-z-set! res (+ (* i (- (* x z (- 1. c)) (* y s)))
                          (* j (+ (* y z (- 1. c)) (* x s)))
                          (* k (+ (* z z (- 1. c)) c)))))
  res)


;;;
;;;; Matrix Operations
;;;


(definition public (make-identity-matrix) <f32vector>
  (make-identity-matrix! (make-matrix)))


(definition public (make-identity-matrix! res <f32vector>) <f32vector>
  (matrix-set! res  0 1.)
  (matrix-set! res  1 0.)
  (matrix-set! res  2 0.)
  (matrix-set! res  3 0.)
  (matrix-set! res  4 0.)
  (matrix-set! res  5 1.)
  (matrix-set! res  6 0.)
  (matrix-set! res  7 0.)
  (matrix-set! res  8 0.)
  (matrix-set! res  9 0.)
  (matrix-set! res 10 1.)
  (matrix-set! res 11 0.)
  (matrix-set! res 12 0.)
  (matrix-set! res 13 0.)
  (matrix-set! res 14 0.)
  (matrix-set! res 15 1.)
  res)


(definition public (matrix-multiply a <f32vector> b <f32vector>) <f32vector>
  (matrix-multiply! (make-matrix) a b))


(definition public (matrix-multiply! res <f32vector> a <f32vector> b <f32vector>) <f32vector>
  (loop (for i from 0 below 4)
        (loop (for j from 0 below 4)
              (let ((ind (+ (* j 4) i)))
                (matrix-set! res ind 0.)
                (loop (for k from 0 below 4)
                      (matrix-set! res ind (+ (matrix-ref res ind)
                                              (* (matrix-ref a (+ (* k 4) i))
                                                 (matrix-ref b (+ (* j 4) k)))))))))
  res)


(definition public (matrix-tranform mat <f32vector> vert <f32vector>) <f32vector>
  (let ((x (vertex-x vert))
        (y (vertex-y vert))
        (z (vertex-z vert)))
    (let ((s (+ (* (matrix-ref mat 3) x) (* (matrix-ref mat 7) y) (* (matrix-ref mat 11) z) (matrix-ref mat 15))))
      (vertex (/ (+ (* (matrix-ref mat 0) x) (* (matrix-ref mat 4) y) (* (matrix-ref mat 8) z) (matrix-ref mat 12)) s)
              (/ (+ (* (matrix-ref mat 1) x) (* (matrix-ref mat 5) y) (* (matrix-ref mat 9) z) (matrix-ref mat 13)) s)
              (/ (+ (* (matrix-ref mat 2) x) (* (matrix-ref mat 6) y) (* (matrix-ref mat 10) z) (matrix-ref mat 14)) s)))))


(definition public (make-translation-matrix tx <fl> ty <fl> tz <fl>) <f32vector>
  (make-translation-matrix! (make-matrix) tx ty tz))


(definition public (make-translation-matrix! res <f32vector> tx <fl> ty <fl> tz <fl>) <f32vector>
  (make-identity-matrix! res)
  (matrix-set! res 12 tx)
  (matrix-set! res 13 ty)
  (matrix-set! res 14 tz)
  res)


(definition public (make-x-rotation-matrix phi <fl>) <f32vector>
  (make-x-rotation-matrix! (make-matrix) phi))


(definition public (make-x-rotation-matrix! res <f32vector> phi <fl>)
  (make-identity-matrix! res)
  (let ((cos (cos phi))
        (sin (sin phi)))
    (matrix-set! res 5 cos)
    (matrix-set! res 6 (- sin))
    (matrix-set! res 9 sin)
    (matrix-set! res 10 cos)))


(definition public (make-y-rotation-matrix theta <fl>) <f32vector>
  (make-y-rotation-matrix! (make-matrix) theta))


(definition public (make-y-rotation-matrix! res <f32vector> theta <fl>)
  (make-identity-matrix! res)
  (let ((cos (cos theta))
        (sin (sin theta)))
    (matrix-set! res 0 cos)
    (matrix-set! res 2 sin)
    (matrix-set! res 8 (- sin))
    (matrix-set! res 10 cos)))


(definition public (make-z-rotation-matrix psi <fl>) <f32vector>
  (make-z-rotation-matrix! (make-matrix) psi))


(definition public (make-z-rotation-matrix! res <f32vector> psi <fl>)
  (make-identity-matrix! res)
  (let ((cos (cos psi))
        (sin (sin psi)))
    (matrix-set! res 0 cos)
    (matrix-set! res 1 (- sin))
    (matrix-set! res 4 sin)
    (matrix-set! res 5 cos)))


(definition public (make-rotation-matrix rx <fl> ry <fl> rz <fl>) <f32vector>
  (matrix-multiply (make-x-rotation-matrix rx)
                   (matrix-multiply (make-y-rotation-matrix ry)
                                    (make-z-rotation-matrix rz))))


(definition public (make-scaling-matrix sx <fl> sy <fl> sz <fl>) <f32vector>
  (make-scaling-matrix! (make-matrix) sx sy sz))


(definition public (make-scaling-matrix! res <f32vector> sx <fl> sy <fl> sz <fl>) <f32vector>
  (make-identity-matrix! res)
  (matrix-set! res 0 sx)
  (matrix-set! res 5 sy)
  (matrix-set! res 10 sz)
  res)


(definition public (make-lookat-matrix lookat <LookAt>) <f32vector>
  (make-lookat-matrix! (make-matrix) lookat))


(definition public (make-lookat-matrix! res <f32vector> lookat <LookAt>) <f32vector>
  (make-identity-matrix! res)
  (let ((sight (get-sight~ lookat))
        (up (get-up~ lookat))
        (right (get-right~ lookat)))
    (matrix-set! res 0 (vertex-x right)) (matrix-set! res 4 (vertex-x up)) (matrix-set! res  8 (vertex-x sight))
    (matrix-set! res 1 (vertex-y right)) (matrix-set! res 5 (vertex-y up)) (matrix-set! res  9 (vertex-y sight))
    (matrix-set! res 2 (vertex-z right)) (matrix-set! res 6 (vertex-z up)) (matrix-set! res 10 (vertex-z sight)))
  res)


(definition public (make-projection-matrix fov <fl> ratio <fl> near <fl> far <fl>) <f32vector>
  (make-projection-matrix! (make-identity-matrix) fov ratio near far))


(definition public (make-projection-matrix! res <f32vector> fov <fl> ratio <fl> near <fl> far <fl>) <f32vector>
  (let ((f (/ 1.0 (tan (* fov (/ PI 360.))))))
    (matrix-set! res  0 (/ f ratio))
    (matrix-set! res  5 f)
    (matrix-set! res 10 (/ (+ far near) (- near far)))
    (matrix-set! res 14 (/ (* 2.0 far near) (- near far)))
    (matrix-set! res 11 -1.)
    (matrix-set! res 15 0.))
  res)


(definition public (make-view-matrix position <f32vector> lookat <LookAt>) <f32vector>
  (make-view-matrix! (make-identity-matrix) position lookat))


(definition public (make-view-matrix! res <f32vector> position <f32vector> lookat <LookAt>) <f32vector>
  (let* ((sight (get-sight~ lookat))
         (up (get-up~ lookat))
         (right (get-right~ lookat))
         (view (matrix (vertex-x right)     (vertex-y right)     (vertex-z right)     0.0
                       (vertex-x up)        (vertex-y up)        (vertex-z up)        0.0
                       (- (vertex-x sight)) (- (vertex-y sight)) (- (vertex-z sight)) 0.0
                       0.0                  0.0                  0.0                  1.0))
         (translate (make-translation-matrix (- (vertex-x position))
                                             (- (vertex-y position))
                                             (- (vertex-z position)))))
    (matrix-multiply! res view translate))))
