;;;==============
;;;  JazzScheme
;;;==============
;;;
;;;; World Geometry Classes
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2013
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.geometry.classes jazz


(import (jazz.geometry)
        (jazz.graphic)
        (jazz.graphic.opengl.glew)
        (world)
        (world.syntax (phase syntax)))


(proclaim (warn optimizations))

(declare (optimize-dead-local-variables))


;;;
;;;; Vertex
;;;


(definition public Vertex
  F64Vector)


(definition public inline (vertex x <fl> y <fl> z <fl>) <f64vector>
  (debug-allocation vertex)
  (f64vector (assert-finite x)
             (assert-finite y)
             (assert-finite z)))


(definition public inline (make-vertex) <f64vector>
  (debug-allocation make-vertex)
  (allocate-vertex))


(definition public inline (make-zero-vertex) <f64vector>
  (vertex 0. 0. 0.))


(definition public (copy-vertex vert <f64vector>) <f64vector>
  (let ((copy (make-vertex)))
    (vertex-copy! copy vert)
    copy))


;; clone doesn't validate content
(definition public (clone-vertex vert <f64vector>) <f64vector>
  (let ((clone (make-vertex)))
    (f64vector-set! clone 0 (f64vector-ref vert 0))
    (f64vector-set! clone 1 (f64vector-ref vert 1))
    (f64vector-set! clone 2 (f64vector-ref vert 2))
    clone))


(definition public inline (vertex-x vert <f64vector>) <fl>
  (assert-finite (f64vector-ref vert 0)))

(definition public inline (vertex-y vert <f64vector>) <fl>
  (assert-finite (f64vector-ref vert 1)))

(definition public inline (vertex-z vert <f64vector>) <fl>
  (assert-finite (f64vector-ref vert 2)))


(definition public inline (vertex-x-set! vert <f64vector> x <fl>) <void>
  (f64vector-set! vert 0 (assert-finite x)))

(definition public inline (vertex-y-set! vert <f64vector> y <fl>) <void>
  (f64vector-set! vert 1 (assert-finite y)))

(definition public inline (vertex-z-set! vert <f64vector> z <fl>) <void>
  (f64vector-set! vert 2 (assert-finite z)))


(definition public (vertex=? v1 <f64vector> v2 <f64vector>) <bool>
  (and (= (vertex-x v1) (vertex-x v2))
       (= (vertex-y v1) (vertex-y v2))
       (= (vertex-z v1) (vertex-z v2))))


(definition public (vertex/=? v1 <f64vector> v2 <f64vector>) <bool>
  (or (/= (vertex-x v1) (vertex-x v2))
      (/= (vertex-y v1) (vertex-y v2))
      (/= (vertex-z v1) (vertex-z v2))))


(definition public (vertex-zero? vert <f64vector>) <bool>
  (and (= (vertex-x vert) 0.)
       (= (vertex-y vert) 0.)
       (= (vertex-z vert) 0.)))


(definition public (vertex-zero! vert <f64vector>) <f64vector>
  (vertex-x-set! vert 0.)
  (vertex-y-set! vert 0.)
  (vertex-z-set! vert 0.)
  vert)


(definition public (vertex-init! vert <f64vector> x <fl> y <fl> z <fl>) <f64vector>
  (vertex-x-set! vert x)
  (vertex-y-set! vert y)
  (vertex-z-set! vert z)
  vert)


(definition public (vertex-copy! dst <f64vector> src <f64vector>) <f64vector>
  (vertex-x-set! dst (vertex-x src))
  (vertex-y-set! dst (vertex-y src))
  (vertex-z-set! dst (vertex-z src))
  dst)


(definition public (vertex-hash vert <f64vector>)
  (fxwrap+ (eqv?-hash (vertex-x vert))
           (eqv?-hash (vertex-y vert))
           (eqv?-hash (vertex-z vert))))


(definition public (present-vertex vert)
  (format "~{Vertex {r precision: 3} {r precision: 3} {r precision: 3}}"
          (vertex-x vert)
          (vertex-y vert)
          (vertex-z vert)))


;;;
;;;; Quaternion
;;;


(definition public Quaternion
  F64Vector)


(definition public inline (quaternion x <fl> y <fl> z <fl> w <fl>) <f64vector>
  (debug-allocation quaternion)
  (f64vector x y z w))


(definition public inline (make-quaternion) <f64vector>
  (debug-allocation make-quaternion)
  (make-f64vector 4))


(definition public inline (quaternion-x quat <f64vector>) <fl>
  (f64vector-ref quat 0))

(definition public inline (quaternion-y quat <f64vector>) <fl>
  (f64vector-ref quat 1))

(definition public inline (quaternion-z quat <f64vector>) <fl>
  (f64vector-ref quat 2))

(definition public inline (quaternion-w quat <f64vector>) <fl>
  (f64vector-ref quat 3))


(definition public inline (quaternion-x-set! quat <f64vector> x <fl>) <void>
  (f64vector-set! quat 0 x))

(definition public inline (quaternion-y-set! quat <f64vector> y <fl>) <void>
  (f64vector-set! quat 1 y))

(definition public inline (quaternion-z-set! quat <f64vector> z <fl>) <void>
  (f64vector-set! quat 2 z))

(definition public inline (quaternion-w-set! quat <f64vector> w <fl>) <void>
  (f64vector-set! quat 3 w))


(definition public (quaternion-init! quat <f64vector> x <fl> y <fl> z <fl> w <fl>) <f64vector>
  (quaternion-x-set! quat x)
  (quaternion-y-set! quat y)
  (quaternion-z-set! quat z)
  (quaternion-w-set! quat w)
  quat)


(definition public (quaternion-copy! dst <f64vector> src <f64vector>) <f64vector>
  (quaternion-x-set! dst (quaternion-x src))
  (quaternion-y-set! dst (quaternion-y src))
  (quaternion-z-set! dst (quaternion-z src))
  (quaternion-w-set! dst (quaternion-w src))
  dst)


;;;
;;;; Cuboid
;;;


(definition public Cuboid
  F64Vector)


(definition public inline (cuboid left <fl> bottom <fl> back <fl> right <fl> top <fl> front <fl>) <f64vector>
  (debug-allocation cuboid)
  (f64vector left bottom back right top front))


(definition public inline (make-cuboid) <f64vector>
  (debug-allocation make-cuboid)
  (make-f64vector 6))


(definition public (copy-cuboid cub <f64vector>) <f64vector>
  (let ((copy (make-cuboid)))
    (cuboid-copy! copy cub)
    copy))


(definition public inline (cuboid-left cub <f64vector>) <fl>
  (f64vector-ref cub 0))

(definition public inline (cuboid-bottom cub <f64vector>) <fl>
  (f64vector-ref cub 1))

(definition public inline (cuboid-back cub <f64vector>) <fl>
  (f64vector-ref cub 2))

(definition public inline (cuboid-right cub <f64vector>) <fl>
  (f64vector-ref cub 3))

(definition public inline (cuboid-top cub <f64vector>) <fl>
  (f64vector-ref cub 4))

(definition public inline (cuboid-front cub <f64vector>) <fl>
  (f64vector-ref cub 5))


(definition public (cuboid-width cub <f64vector>) <fl>
  (- (cuboid-right cub)
     (cuboid-left cub)))


(definition public (cuboid-height cub <f64vector>) <fl>
  (- (cuboid-top cub)
     (cuboid-bottom cub)))


(definition public (cuboid-depth cub <f64vector>) <fl>
  (- (cuboid-front cub)
     (cuboid-back cub)))


(definition public inline (cuboid-left-set! cub <f64vector> left <fl>) <void>
  (f64vector-set! cub 0 left))

(definition public inline (cuboid-bottom-set! cub <f64vector> bottom <fl>) <void>
  (f64vector-set! cub 1 bottom))

(definition public inline (cuboid-back-set! cub <f64vector> back <fl>) <void>
  (f64vector-set! cub 2 back))

(definition public inline (cuboid-right-set! cub <f64vector> right <fl>) <void>
  (f64vector-set! cub 3 right))

(definition public inline (cuboid-top-set! cub <f64vector> top <fl>) <void>
  (f64vector-set! cub 4 top))

(definition public inline (cuboid-front-set! cub <f64vector> front <fl>) <void>
  (f64vector-set! cub 5 front))


(definition public (cuboid-init! cub <f64vector> left <fl> bottom <fl> back <fl> right <fl> top <fl> front <fl>) <f64vector>
  (cuboid-left-set! cub left)
  (cuboid-bottom-set! cub bottom)
  (cuboid-back-set! cub back)
  (cuboid-right-set! cub right)
  (cuboid-top-set! cub top)
  (cuboid-front-set! cub front)
  cub)


(definition public (cuboid-copy! dst <f64vector> src <f64vector>) <f64vector>
  (cuboid-left-set! dst (cuboid-left src))
  (cuboid-bottom-set! dst (cuboid-bottom src))
  (cuboid-back-set! dst (cuboid-back src))
  (cuboid-right-set! dst (cuboid-right src))
  (cuboid-top-set! dst (cuboid-top src))
  (cuboid-front-set! dst (cuboid-front src))
  dst)


(definition public (cuboid-scalar*! res <f64vector> cub <f64vector> r <fl>) <f64vector>
  (cuboid-left-set! res (* r (cuboid-left cub)))
  (cuboid-bottom-set! res (* r (cuboid-bottom cub)))
  (cuboid-back-set! res (* r (cuboid-back cub)))
  (cuboid-right-set! res (* r (cuboid-right cub)))
  (cuboid-top-set! res (* r (cuboid-top cub)))
  (cuboid-front-set! res (* r (cuboid-front cub)))
  res)


;;;
;;;; Matrix
;;;


;; 0  4  8 12
;; 1  5  9 13
;; 2  6 10 14
;; 3  7 11 15


(definition public Matrix
  F64Vector)


(definition public (matrix f0 <fl> f4 <fl> f8 <fl> f12 <fl> f1 <fl> f5 <fl> f9 <fl> f13 <fl> f2 <fl> f6 <fl> f10 <fl> f14 <fl> f3 <fl> f7 <fl> f11 <fl> f15 <fl>) <f64vector>
  (debug-allocation matrix)
  (f64vector f0 f1 f2 f3 f4 f5 f6 f7 f8 f9 f10 f11 f12 f13 f14 f15))


(definition public (make-matrix) <f64vector>
  (debug-allocation make-matrix)
  (make-f64vector 16))


(definition public (copy-matrix mat <f64vector>) <f64vector>
  (let ((copy (make-matrix)))
    (matrix-copy! copy mat)
    copy))


(definition public inline (matrix-ref mat <f64vector> ind <fx>) <fl>
  (f64vector-ref mat ind))


(definition public inline (matrix-set! mat <f64vector> ind <fx> val <object>) <void>
  (f64vector-set! mat ind val))


(definition public (matrix=? m1 <f64vector> m2 <f64vector>) <bool>
  (and (= (matrix-ref m1  0) (matrix-ref m2  0))
       (= (matrix-ref m1  1) (matrix-ref m2  1))
       (= (matrix-ref m1  2) (matrix-ref m2  2))
       (= (matrix-ref m1  3) (matrix-ref m2  3))
       (= (matrix-ref m1  4) (matrix-ref m2  4))
       (= (matrix-ref m1  5) (matrix-ref m2  5))
       (= (matrix-ref m1  6) (matrix-ref m2  6))
       (= (matrix-ref m1  7) (matrix-ref m2  7))
       (= (matrix-ref m1  8) (matrix-ref m2  8))
       (= (matrix-ref m1  9) (matrix-ref m2  9))
       (= (matrix-ref m1 10) (matrix-ref m2 10))
       (= (matrix-ref m1 11) (matrix-ref m2 11))
       (= (matrix-ref m1 12) (matrix-ref m2 12))
       (= (matrix-ref m1 13) (matrix-ref m2 13))
       (= (matrix-ref m1 14) (matrix-ref m2 14))
       (= (matrix-ref m1 15) (matrix-ref m2 15))))


(definition public (matrix-copy! dst <f64vector> src <f64vector>) <f64vector>
  (matrix-set! dst  0 (matrix-ref src 0))
  (matrix-set! dst  1 (matrix-ref src 1))
  (matrix-set! dst  2 (matrix-ref src 2))
  (matrix-set! dst  3 (matrix-ref src 3))
  (matrix-set! dst  4 (matrix-ref src 4))
  (matrix-set! dst  5 (matrix-ref src 5))
  (matrix-set! dst  6 (matrix-ref src 6))
  (matrix-set! dst  7 (matrix-ref src 7))
  (matrix-set! dst  8 (matrix-ref src 8))
  (matrix-set! dst  9 (matrix-ref src 9))
  (matrix-set! dst 10 (matrix-ref src 10))
  (matrix-set! dst 11 (matrix-ref src 11))
  (matrix-set! dst 12 (matrix-ref src 12))
  (matrix-set! dst 13 (matrix-ref src 13))
  (matrix-set! dst 14 (matrix-ref src 14))
  (matrix-set! dst 15 (matrix-ref src 15))
  dst)


(definition public (debug-matrix mat)
  (format :console "{r precision: 3} {r precision: 3} {r precision: 3} {r precision: 3}{%}" (matrix-ref mat 0) (matrix-ref mat 4) (matrix-ref mat 8) (matrix-ref mat 12))
  (format :console "{r precision: 3} {r precision: 3} {r precision: 3} {r precision: 3}{%}" (matrix-ref mat 1) (matrix-ref mat 5) (matrix-ref mat 9) (matrix-ref mat 13))
  (format :console "{r precision: 3} {r precision: 3} {r precision: 3} {r precision: 3}{%}" (matrix-ref mat 2) (matrix-ref mat 6) (matrix-ref mat 10) (matrix-ref mat 14))
  (format :console "{r precision: 3} {r precision: 3} {r precision: 3} {r precision: 3}{%}" (matrix-ref mat 3) (matrix-ref mat 7) (matrix-ref mat 11) (matrix-ref mat 15))))
