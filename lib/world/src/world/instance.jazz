;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; World Instance
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2016
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.instance jazz


(import (jazz.application)
        (jazz.debuggee)
        (jazz.io)
        (jazz.jrm)
        (jazz.network)
        (world)
        (world.autoload)
        (world.master)
        (world.settings)
        (world.syntax (phase syntax))
        (world.work))


;;;
;;;; Instance
;;;


(definition protected instances
  (make-table test: equal?))


(definition protected (spawn-instance name)
  (let ((uuid (make-uuid))
        (processor (spawn-processor name)))
    (table-set! instances uuid processor)
    processor))


(definition protected (kill-instances)
  (iterate-table-safe instances
    (lambda (uuid processor)
      (kill-instance uuid))))


(definition protected (kill-instance uuid)
  (let ((processor (table-ref instances uuid)))
    (kill-processor processor)
    (table-clear instances uuid)))


;;;
;;;; Processor
;;;


(definition (processor-debug?)
  (world-setting 'world.processor-debug? #f))


(definition protected (spawn-processor instance)
  (start-remote-listener)
  (let ((debug? (processor-debug?)))
    (spawn-slave-process "processor" (get-processor-filename)
      (lambda (slave cookie)
        (let ((server (load-object~ (get-local-register) 'world.server.remote 'world-remote-server))
              (worker (require-worker)))
          (processor-setup~ slave server worker))
        slave)
      arguments: `("-instance" ,instance)
      debug?: debug?
      wait?: #t)))


(definition protected (kill-processor processor)
  (processor-quit~ processor))


;;;
;;;; Exit
;;;


(add-exit-job! kill-instances))
