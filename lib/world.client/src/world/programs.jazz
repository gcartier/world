;;;==============
;;;  JazzScheme
;;;==============
;;;
;;;; Shader Programs
;;;


(module world.programs jazz


(import (jazz.geometry)
        (jazz.graphic)
        (jazz.graphic.opengl.glew)
        (jazz.io)
        (jazz.library)
        (jazz.literals)
        (jazz.media)
        (jazz.network)
        (jazz.platform)
        (jazz.platform.cairo)
        (jazz.runtime)
        (jazz.system)
        (jazz.ui)
        (jazz.ui.dialog)
        (jazz.ui.window)
        (world)
        (world.foreign)
        (world.shader)
        (world.shaders)
        (time))


;;;
;;;; Asset
;;;


(class Asset-Program extends Shader-Program
  
  
  (method protected virtual (bind-uniforms)
    )
  
  
  (method protected virtual (enable-attributes vao)
    )
  
  
  (method protected virtual (set-attributes vao)
    )
  
  
  (method protected virtual (disable-attributes vao)
    ))


;;;
;;;; Asset-Color
;;;


(class Asset-Color-Program extends Asset-Program
  
  
  (method override (prepare)
    (set-vs color-asset-vs)
    (set-fs color-asset-fs)
    (link)
    (add-attribute "vertex_coord"))
  
  
  (method override (bind-uniforms)
    )
  
  
  (method override (enable-attributes vao)
    (enable-vertex-attrib~ vao (get-attribute "vertex_coord")))
  
  
  (method override (set-attributes vao)
    (set-attrib-pointer~ vao (get-attribute "vertex_coord") stride: 36))
  
  
  (method override (disable-attributes vao)
    (disable-vertex-attrib~ vao (get-attribute "vertex_coord"))))


;;;
;;;; Asset-Texture
;;;


(class Asset-Texture-Program extends Asset-Program
  
  
  (method override (prepare)
    (set-vs texture-asset-vs)
    (set-fs texture-asset-fs)
    (link)
    (add-uniform "texture")
    (add-attribute "vertex_coord")
    (add-attribute "texture_coord")
    (add-attribute "normal"))
  
  
  (method override (bind-uniforms)
    (glActiveTexture GL_TEXTURE0)
    (glBindTexture GL_TEXTURE_2D (get-texture~ (get-asset-texture~ world)))
    (glUniform1i (get-uniform "texture") 0))
  
  
  (method override (enable-attributes vao)
    (enable-vertex-attrib~ vao (get-attribute "vertex_coord"))
    (enable-vertex-attrib~ vao (get-attribute "texture_coord"))
    (enable-vertex-attrib~ vao (get-attribute "normal")))
  
  
  (method override (set-attributes vao)
    (set-attrib-pointer~ vao (get-attribute "vertex_coord") stride: 36)
    (set-attrib-pointer~ vao (get-attribute "texture_coord") stride: 36 offset: 12)
    (set-attrib-pointer~ vao (get-attribute "normal") stride: 36 offset: 24))
  
  
  (method override (disable-attributes vao)
    (disable-vertex-attrib~ vao (get-attribute "vertex_coord"))
    (disable-vertex-attrib~ vao (get-attribute "texture_coord"))
    (disable-vertex-attrib~ vao (get-attribute "normal"))))


;;;
;;;; Asset-Phong
;;;


(class Asset-Phong-Program extends Asset-Program
  
  
  (method override (prepare)
    (set-vs phong-nlights-asset-vs)
    (set-fs phong-nlights-asset-fs)
    (link)
    (add-uniform "texture")
    (add-uniform "lights_count")
    (add-attribute "vertex_coord")
    (add-attribute "texture_coord")
    (add-attribute "normal"))
  
  
  (method override (bind-uniforms)
    (glActiveTexture GL_TEXTURE0)
    (glBindTexture GL_TEXTURE_2D (get-texture~ (get-asset-texture~ world)))
    (glUniform1i (get-uniform "texture") 0)
    (glUniform1i (get-uniform "lights_count") (count-lights~ zone)))
  
  
  (method override (enable-attributes vao)
    (enable-vertex-attrib~ vao (get-attribute "vertex_coord"))
    (enable-vertex-attrib~ vao (get-attribute "texture_coord"))
    (enable-vertex-attrib~ vao (get-attribute "normal")))
  
  
  (method override (set-attributes vao)
    (set-attrib-pointer~ vao (get-attribute "vertex_coord") stride: 36)
    (set-attrib-pointer~ vao (get-attribute "texture_coord") stride: 36 offset: 12)
    (set-attrib-pointer~ vao (get-attribute "normal") stride: 36 offset: 24))
  
  
  (method override (disable-attributes vao)
    (disable-vertex-attrib~ vao (get-attribute "vertex_coord"))
    (disable-vertex-attrib~ vao (get-attribute "texture_coord"))
    (disable-vertex-attrib~ vao (get-attribute "normal")))))
