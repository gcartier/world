;;;==============
;;;  JazzScheme
;;;==============
;;;
;;;; World Entities
;;;


(module world.entity jazz


(import (jazz.jml)
        (jazz.graphic)
        (jazz.graphic.opengl.glew)
        (world)
        (world.draw)
        (world.foreign)
        (world.foreign.obj)
        (world.gadget)
        (world.geometry)
        (world.mesh)
        (world.object)
        (world.shader)
        (world.sprite))


;;;
;;;; Model-Entity
;;;


(class Model-Entity extends Sprite
  
  
  (property model  <object> initialize #f accessors generate)
  (property matrix <object> initialize #f accessors generate)
  
  
  (method override (prepare rest)
    (nextmethod rest)
    (set! width 5.)
    (set! height 5.)
    (set! depth 5.)
    (set! color {Color White}))
  
  
  ;;;
  ;;;; Draw
  ;;;
  
  
  (method override (draw-3d-textured)
    (draw-entity))
  
  
  (method override (draw-3d)
    (draw-entity))
  
  
  (method (draw-entity)
    (let ((mesh (get-mesh~ model))
          (texture (get-texture~ model))
          (program (get-model-program~ world)))
      (activate~ program)
      (bind-uniforms~ program model matrix)
      (enable-attributes~ program mesh)
      (activate~ mesh)
      (set-attributes~ program mesh)
      (draw~ mesh)
      (disable-attributes~ program mesh)
      (deactivate~ mesh)
      (deactivate~ program)
      (unbind-uniforms~ program)))))
