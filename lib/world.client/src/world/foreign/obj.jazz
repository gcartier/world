;;;==============
;;;  JazzScheme
;;;==============
;;;
;;;; World Obj
;;;


(module world.foreign.obj jazz


(import (jazz.platform.types))


(c-declare #<<c-includes
	#include "list.c"
	#include "string_extra.c"
	#include "obj_parser.c"
c-includes
)


(definition public parse-obj
  (c-function (char-string) scheme-object
    "obj_scene_data data;
     parse_obj_scene(&data, ___arg1);
     
     
     ___SCMOBJ r = ___EXT(___alloc_scmobj) (___sF32VECTOR, data.face_count*9*3*4, ___STILL);
     float *ptr = ___CAST(float*,___BODY(r));
     
     obj_face* f;
     obj_vector *v,*n,*t;
     int index = 0;
     int i;
     int j;
     for(i=0; i<data.face_count; i++)
     {
      f = data.face_list[i];
      for(j=0; j<3; j++)
      {
          v = data.vertex_list[f->vertex_index[j]];
          n = data.vertex_normal_list[f->normal_index[j]];
          t = data.vertex_texture_list[f->texture_index[j]];
          ptr[index] = (float)v->e[0]; index++;          
          ptr[index] = (float)v->e[1]; index++;          
          ptr[index] = (float)v->e[2]; index++;          
          ptr[index] = (float)t->e[0]; index++;          
          ptr[index] = (float)t->e[1]; index++;          
          ptr[index] = 1.0f;           index++;          
          ptr[index] = (float)n->e[0]; index++;
          ptr[index] = (float)n->e[1]; index++;
          ptr[index] = (float)n->e[2]; index++;         
      }
     }
     
     
     delete_obj_data(&data);
     ___result = r;"
    )
  
  )


)
