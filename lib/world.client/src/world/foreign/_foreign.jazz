;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; World Foreign
;;;
;;;  The contents of this file are subject to the Mozilla Public License Version
;;;  1.1 (the "License"); you may not use this file except in compliance with
;;;  the License. You may obtain a copy of the License at
;;;  http://www.mozilla.org/MPL/
;;;
;;;  Software distributed under the License is distributed on an "AS IS" basis,
;;;  WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
;;;  for the specific language governing rights and limitations under the
;;;  License.
;;;
;;;  The Original Code is WorldScheme.
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2014
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):
;;;
;;;  Alternatively, the contents of this file may be used under the terms of
;;;  the GNU General Public License Version 2 or later (the "GPL"), in which
;;;  case the provisions of the GPL are applicable instead of those above. If
;;;  you wish to allow use of your version of this file only under the terms of
;;;  the GPL, and not to allow others to use your version of this file under the
;;;  terms of the MPL, indicate your decision by deleting the provisions above
;;;  and replace them with the notice and other provisions required by the GPL.
;;;  If you do not delete the provisions above, a recipient may use your version
;;;  of this file under the terms of any one of the MPL or the GPL.
;;;
;;;  See http://github.com/gcartier/world for details.


(module world.foreign jazz


(import (jazz.foreign)
        (jazz.graphic.opengl.glew)
        (jazz.platform.types))


(c-external (test-malloc int) void*
  #<<end-of-c-code
    ___result = malloc(___arg1);
end-of-c-code
)


(c-include "<stdlib.h>")
(c-include "<string.h>")
(c-include "<GL/glew.h>")


(c-external (sizeof-size_t ) int
  "___result = sizeof(size_t);")

(c-external (sizeof-float ) int
  "___result = sizeof(float);")

(c-external (sizeof-double ) int
  "___result = sizeof(double);")


(definition public size_t-size <fx>
  (sizeof-size_t))

(definition public float-size <fx>
  (sizeof-float))

(definition public double-size <fx>
  (sizeof-double))


(c-external (subu8vector->foreign scheme-object int int) void*
  #<<end-of-c-code
    ___U8 *ptr = ___CAST(___U8*,___BODY(___arg1));
    int from = ___arg2;
    int to = ___arg3;
    int size = to - from;
    ___U8 *foreign = malloc(size);
    memcpy(foreign, ptr + from, size);
    ___result = foreign;
end-of-c-code
)


(c-external (BGRA-premultiply-alpha scheme-object int int bool) void*
  #<<end-of-c-code
    ___U8 *ptr = ___CAST(___U8*,___BODY(___arg1));
    int from = ___arg2;
    int to = ___arg3;
    int premultiply = ___arg4;
    int size = to - from;
    ___U8 *foreign = malloc(size);
    memcpy(foreign, ptr + from, size);
    if (premultiply)
    {
        int i, b, g, r, a;
        float alpha;
        for (i = 0; i < size; i += 4)
        {
            b = foreign[i];
            g = foreign[i+1];
            r = foreign[i+2];
            a = foreign[i+3];
            alpha = ((float) a) / 255.;
            foreign[i]   = ((float) b) * alpha;
            foreign[i+1] = ((float) g) * alpha;
            foreign[i+2] = ((float) r) * alpha;
        }
    }
    ___result = foreign;
end-of-c-code
)


@opengl-debugging
(c-declare world.foreign #<<c-declare
BOOL logging = TRUE;

FILE *logfile = NULL;

static void print(char* string)
{
	if (logging)
	{
		if (!logfile)
			logfile = fopen("log.txt", "w");
		
		fprintf(logfile, string);
		fflush(logfile);
	}
}

static void vprint(char* format, va_list arguments)
{
	if (logging)
	{
		if (!logfile)
			logfile = fopen("log.txt", "w");
		
		vfprintf(logfile, format, arguments);
		fflush(logfile);
	}
}

static void printlog(char* format, ...)
{
	va_list arguments;

	va_start(arguments, format);
	vprint(format, arguments);
	print("\n");
	va_end(arguments);
}
c-declare
)


@opengl-debugging
(c-declare world.foreign #<<c-declare
static void message_callback(GLenum source,
                             GLenum type,
                             GLuint id,
                             GLenum severity,
                             GLsizei length,
                             const GLchar* message,
                             GLvoid* userParam)
{
	printlog("%s", message);
}
c-declare
)


@opengl-debugging
(c-external (gl-setup-debugging) int
  #<<end-of-c-code
	// glDebugMessageEnableAMD(GL_DONT_CARE, GL_DONT_CARE, GL_DONT_CARE, 0, NULL, GL_TRUE);
	glDebugMessageCallbackAMD(&message_callback, NULL);
	glDebugMessageInsertAMD(GL_DEBUG_CATEGORY_OTHER_AMD, GL_DEBUG_SEVERITY_LOW_AMD, 0, 5, "hello world");
end-of-c-code
)


(c-external (glGenFramebuffers*) GLuint
    "GLuint buffer;
     glGenFramebuffers(1, &buffer);
     ___result = buffer;")
   
   
(c-external (glGenRenderbuffers*) GLuint
    "GLuint buffer;
     glGenRenderbuffers(1, &buffer);
     ___result = buffer;")


(c-external (glDeleteTextures* GLuint) void
    "glDeleteTextures(1, &___arg1);")


(c-external (glDeleteRenderbuffers* GLuint) void
    "glDeleteRenderbuffers(1, &___arg1);")


(c-external (glDeleteFramebuffers* GLuint) void
    "glDeleteFramebuffers(1, &___arg1);")


(c-external (glDeleteBuffers* GLuint) void
    "glDeleteBuffers(1, &___arg1);")


(c-external (glDeleteVertexArrays* GLuint) void
    "glDeleteVertexArrays(1, &___arg1);")


(c-external (glGenVertices*) GLuint
    "GLuint vbo_fbo_vertices = 0;
    GLfloat fbo_vertices[] = {
    -1, -1,
     1, -1,
    -1,  1,
     1,  1,
  };
  glGenBuffers(1, &vbo_fbo_vertices);
  glBindBuffer(GL_ARRAY_BUFFER, vbo_fbo_vertices);
  glBufferData(GL_ARRAY_BUFFER, sizeof(fbo_vertices), fbo_vertices, GL_STATIC_DRAW);
  glBindBuffer(GL_ARRAY_BUFFER, 0);
  ___result = vbo_fbo_vertices;")


(c-external (glGetShaderInfoLog* GLuint GLsizei) char-string
    "GLchar* log = (GLchar*)malloc(___arg2);
     GLsizei slen = 0;
     glGetShaderInfoLog(___arg1, ___arg2, &slen, log);
     ___result = log;")


(c-external (glGetProgramInfoLog* GLuint GLsizei) char-string
    "GLchar* log = (GLchar*)malloc(___arg2);
     GLsizei slen = 0;
     glGetProgramInfoLog(___arg1, ___arg2, &slen, log);
     ___result = log;")
)
