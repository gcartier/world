;;;==============
;;;  JazzScheme
;;;==============
;;;
;;;; World Foreign
;;;


(module world.foreign jazz


(import (jazz.graphic.opengl.glew)
        (jazz.platform.types))


(c-include "<GL/glew.h>")


(definition public gl-sphere
  (c-function (GLdouble GLint GLint) void
    #<<end-of-c-code
    GLdouble radius = ___arg1;
    GLint slices = ___arg2;
    GLint stacks = ___arg3;
    
    GLUquadricObj *quadObj;
    quadObj = gluNewQuadric();
    gluQuadricDrawStyle(quadObj, GLU_FILL);
    gluQuadricNormals(quadObj, GLU_SMOOTH);
    /* If we ever changed/used the texture or orientation state
    of quadObj, we'd need to change it to the defaults here
    with gluQuadricTexture and/or gluQuadricOrientation. */
    gluSphere(quadObj, radius, slices, stacks);
    gluDeleteQuadric(quadObj);
end-of-c-code
))


(definition public render-triangles
  (c-function (scheme-object int GLint) void
    #<<end-of-c-code
    float *ptr = ___CAST(float*,___BODY(___arg1));
    int count = ___arg2;
    GLint mode = ___arg3;
    int n = 0;
    while (n < count)
    {
        glNormal3f(ptr[n+6], ptr[n+7], ptr[n+8]);
        glBegin(mode);
        glVertex3f(ptr[n+0], ptr[n+1], ptr[n+2]);
        glVertex3f(ptr[n+9], ptr[n+10], ptr[n+11]);
        glVertex3f(ptr[n+18], ptr[n+19], ptr[n+20]);
        glEnd();
        n += 27;
    }
end-of-c-code
))


(definition public render-block
  ;; x1 x2 y1 y2 z1 z2
  (c-function (GLfloat GLfloat GLfloat GLfloat GLfloat GLfloat GLuint) void
    "// top
     glNormal3f(0.0, 1.0, 0.0);
     glBegin(___arg7);
     glVertex3f(___arg2, ___arg4, ___arg5);
     glVertex3f(___arg1, ___arg4, ___arg5);
     glVertex3f(___arg1, ___arg4, ___arg6);
     glVertex3f(___arg2, ___arg4, ___arg6);
     glEnd();
     // bottom
     glNormal3f(0.0, -1.0, 0.0);
     glBegin(___arg7);
     glVertex3f(___arg2, ___arg3, ___arg6);
     glVertex3f(___arg1, ___arg3, ___arg6);
     glVertex3f(___arg1, ___arg3, ___arg5);
     glVertex3f(___arg2, ___arg3, ___arg5);
     glEnd();
     // front
     glNormal3f(0.0, 0.0, 1.0);
     glBegin(___arg7);
     glVertex3f(___arg1, ___arg3, ___arg6);
     glVertex3f(___arg2, ___arg3, ___arg6);
     glVertex3f(___arg2, ___arg4, ___arg6);
     glVertex3f(___arg1, ___arg4, ___arg6);
     glEnd();
     // back
     glNormal3f(0.0, 0.0, -1.0);
     glBegin(___arg7);
     glVertex3f(___arg2, ___arg3, ___arg5);
     glVertex3f(___arg1, ___arg3, ___arg5);
     glVertex3f(___arg1, ___arg4, ___arg5);
     glVertex3f(___arg2, ___arg4, ___arg5);
     glEnd();
     // left
     glNormal3f(-1.0, 0.0, 0.0);
     glBegin(___arg7);
     glVertex3f(___arg1, ___arg4, ___arg6);
     glVertex3f(___arg1, ___arg4, ___arg5);
     glVertex3f(___arg1, ___arg3, ___arg5);
     glVertex3f(___arg1, ___arg3, ___arg6);
     glEnd();
     // right
     glNormal3f(1.0, 0.0, 0.0);
     glBegin(___arg7);
     glVertex3f(___arg2, ___arg4, ___arg5);
     glVertex3f(___arg2, ___arg4, ___arg6);
     glVertex3f(___arg2, ___arg3, ___arg6);
     glVertex3f(___arg2, ___arg3, ___arg5);
     glEnd();"))
   
   
(definition public glGenFramebuffersEXT*
  (c-function () GLuint
    "GLuint buffer;
     glGenFramebuffersEXT(1, &buffer);
     ___result = buffer;"))
   
   
(definition public glGenRenderbuffersEXT*
  (c-function () GLuint
    "GLuint buffer;
     glGenRenderbuffersEXT(1, &buffer);
     ___result = buffer;"))
             
(definition public glDeleteTextures*
  (c-function (GLuint) void
    "glDeleteTextures(1, &___arg1);"))
             
(definition public glDeleteRenderbuffersEXT*
  (c-function (GLuint) void
    "glDeleteRenderbuffersEXT(1, &___arg1);"))
             
(definition public glDeleteFramebuffersEXT*
  (c-function (GLuint) void
    "glDeleteFramebuffersEXT(1, &___arg1);"))
             
(definition public glDeleteVertexArrays*
  (c-function (GLuint) void
    "glDeleteVertexArrays(1, &___arg1);"))
   
   
 (definition public glGenVertices*
   (c-function () GLuint
     "GLuint vbo_fbo_vertices = 0;
    GLfloat fbo_vertices[] = {
    -1, -1,
     1, -1,
    -1,  1,
     1,  1,
  };
  glGenBuffers(1, &vbo_fbo_vertices);
  glBindBuffer(GL_ARRAY_BUFFER, vbo_fbo_vertices);
  glBufferData(GL_ARRAY_BUFFER, sizeof(fbo_vertices), fbo_vertices, GL_STATIC_DRAW);
  glBindBuffer(GL_ARRAY_BUFFER, 0);
  ___result = vbo_fbo_vertices;"))

   
(definition public glGetInfoLogARB*
   (c-function (GLhandleARB GLsizei) char-string
    "GLchar* compiler_log = (GLchar*)malloc(___arg2);
     GLsizei slen = 0;
     glGetInfoLogARB(___arg1, ___arg2, &slen, compiler_log);
     ___result = compiler_log;"))
             
 (definition public glTexCoordPointer*
   (c-function (GLint GLenum GLsizei scheme-object int) void
     "float *ptr = ___CAST(float*,___BODY(___arg4));
      glTexCoordPointer(___arg1, ___arg2, ___arg3, ptr + ___arg5);"
   ))
             
 (definition public glVertexPointer*
   (c-function (GLint GLenum GLsizei scheme-object int) void
     "float *ptr = ___CAST(float*,___BODY(___arg4));
      glVertexPointer(___arg1, ___arg2, ___arg3, ptr + ___arg5);"
   ))

 (definition public glVertexAttribPointerCustom*
   (c-function (GLuint GLint GLenum GLboolean GLsizei int) void
     "glVertexAttribPointer(___arg1, ___arg2, ___arg3, ___arg4, ___arg5, ___CAST(void*,___arg6));"
   ))
   
 )
