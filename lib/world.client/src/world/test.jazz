;;;==============
;;;  JazzScheme
;;;==============
;;;
;;;; World Tests
;;;


(module world.test jazz


(import (jazz.graphic)
        (jazz.library)
        (jazz.ui)
        (jazz.ui.view)
        (jazz.ui.window)
        (world)
        (world.entity)
        (world.generate)
        (world.geometry)
        (world.interface)
        (world.interface.inventory)
        (world.interface.menu)
        (world.light)
        (world.material)
        (world.mesh)
        (world.model))


;;;
;;;; Test
;;;


@w
(definition public (test1-world)
  (define (collect-polygons)
    (let ((queue (new-queue)))
      (for-each (lambda (tile)
                  (for-each (lambda (face)
                              (for-each (lambda (triangle)
                                          (enqueue queue
                                                   (new Polygon (list (get-v1~ triangle)
                                                                      (get-v2~ triangle)
                                                                      (get-v3~ triangle))
                                                        (new Plane
                                                          (center-of-mass~ triangle)
                                                          (get-normal~ triangle)))))
                                        (get-triangles~ face)))
                            (get-faces~ tile)))
                (get-tiles~ zone))
      (queue-list queue)))
  
  (let ((polygon-list (collect-polygons))
        (movement (new Movement (copy-vertex (get-eye~ world)) (vertex-scalar* (get-sight~ (get-eye-lookat~ world)) 50.))))
    (debug polygon-list: polygon-list)
    (debug movement: movement)
    (receive (cl hit) (collide-and-slide 1.
                                         polygon-list
                                         movement
                                         #f
                                         #f)
      (debug cl hit))))


(definition public (test1-world)
  (debug (get-focus)))


(definition public (test2-world)
  )


(definition public (test3-world)
  )


(definition public (test4-world)
  )


@test-model
(definition public (test2-world)
  (let ((entity (new Entity x: 0. y: 0. z: 0.)))
    (set-model~ entity (find-model "pyro"))
    (set-matrix~ entity (make-identity-matrix))
    (add-element~ zone entity)))


@test-model
(definition public (test3-world)
  (let ((model (find-model "pyro")))
    (set-model~ me model)
    (set-avatar~ me model)))


@test-model
(definition public (test4-world)
  (set-avatar~ me #f))


(definition public (test5-world)
  (let ((cube (find-named-element~ zone 'cube))
        (target (vertex+ (get-eye~ world) (vertex-scalar* (get-sight~ (get-eye-lookat~ world)) 30.)))
        (count 20)
        (n 0))
    (letrec ((proc
               (lambda ()
                 (if (>= n count)
                     (unregister-draw~ world proc)
                   (let ((scaling (* (/ 10. (cast <fl> count)) (cast <fl> n))))
                     (set-matrix~ cube (matrix-multiply (make-translation-matrix (vertex-x target) (vertex-y target) (vertex-z target)) (make-scaling-matrix scaling scaling scaling)))
                     (increase! n))))))
      (register-draw~ world proc))))


(definition public (test6-world)
  (setup-interface~ world))


(definition public (test7-world)
  (new World-Inventory parent: (get-interface~ world) size: {Dimension 366 588} location: 'center)
  (layout-view~ (get-interface~ world)))


(definition public (test8-world)
  (let ((target (get-target~ world)))
    (if (not target)
        (bell)
      (open-menu
        (new Color-Choose
          size: {Dimension 527 109}
          background: #f
          color: {Color Red}
          feedback: (lambda (color)
                      (set-property~ (get-designer~ zone) target 'color color)
                      (invalidate-lightmaps~ zone target))
          @return-press-handler: (new Event-Handler execute: return-press)
          @escape-press-handler: (new Event-Handler execute: escape-press)
          @focus-lose-handler: (new Event-Handler execute: edition-ended))))))


(definition public (test9-world)
  (let ((timer (new Timer)))
    (set-shadowmaps?~ world #f)
    (recalculate-lightmaps)
    (play-sound-file~ world "sound/explosion")
    (let ((time (format "Time: {a}s" (real-duration~ timer))))
      (set-information~ world (list time))
      (display-status~ world time))))


(definition public (test0-world)
  (let ((timer (new Timer)))
    (set-shadowmaps?~ world #t)
    (recalculate-lightmaps)
    (play-sound-file~ world "sound/explosion")
    (let ((time (format "Time: {a}s" (real-duration~ timer))))
      (set-information~ world (list time))
      (display-status~ world time))))


(definition (recalculate-lightmaps)
  (invalidate-lightmaps~ zone #f)
  (update-lightmaps~ zone)
  (iterate-sectors-with-tiles~ zone
    (lambda (index sector)
      (update-vertices~ sector)
      (set-lightmap-uptodate?~ sector #f)
      (update-lightmap~ sector))))


@w
(definition public (test8-world)
  (case (tier~ (get-application))
    ((server)
     (for-each (lambda (server-client)
                 (let ((client (get-client~ server-client)))
                   (server-test~ client #f)))
               (get-clients~ (get-application))))
    ((client)
     (let ((server (get-remote-server~ (get-application)))
           (client (get-remote-client~ (get-application))))
       (if (not server)
           (bell)
         (client-test~ server client #f))))))


@w
(definition public (test9-world)
  (if (validate-areas~ zone)
      (display-message "Areas valid" color: {Color Green})
    (display-message "Areas corrupted!" color: {Color Red})
    (set-visible?~ (child~ interface 'info) #t)))


@w
(definition public (test0-world)
  (testing? (not (testing?)))
  (display-on/off~ world "Testing" (testing?)))


;;;
;;;; Collision
;;;


(import (world.collision)
        (world.geometry)
        (world.plane)
        (world.polygon))


(define (polygon . vertices)
  (bind (v1 v2 v3) vertices
    (new Polygon vertices (new Plane
                            (triangle-center v1 v2 v3)
                            (plane-normal v1 v2 v3)))))


(definition public (test)
  (let ((sphere-radius 1.)
        (polygon-list (list (polygon (vertex 0. 0. 0.) (vertex 5. 0. 0.) (vertex 2.5 2.5 -5.5))))
        (movement (new Movement (vertex 0.0 0.5 5.) (vertex 0. 0. -10.)))
        (last-direction #f)
        (filter-pulse-jumps #f))
    (debug sphere-radius: sphere-radius)
    (debug polygon-list: polygon-list)
    (debug movement: movement)
    (receive (cl hit) (collide-and-slide sphere-radius
                                         polygon-list
                                         movement
                                         last-direction
                                         filter-pulse-jumps)
      (debug 'cl '-> cl)
      (debug 'hit '-> hit)))))
