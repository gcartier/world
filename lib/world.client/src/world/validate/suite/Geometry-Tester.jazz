;;;==============
;;;  JazzScheme
;;;==============
;;;
;;;; Geometry Tests
;;;


(module protected world.validate.suite.Geometry-Tester jazz


(import (jazz.jml)
        (jazz.locale)
        (jazz.validation)
        (world.geometry))


(class Geometry-Tester extends Tester
  
  
  (form
    (<install> title: "Geometry"))


  (method override (test)
    (invoke #f test-matrix)
    (invoke #f test-cross-product)
    (invoke #f test-ray-intersects-triangle?))
  
  
  ;;;
  ;;;; matrix
  ;;;
  
  
  (method (test-matrix)
    (matrix=? (matrix-multiply (make-identity-matrix) (make-identity-matrix)) (make-identity-matrix)))
  
  
  ;;;
  ;;;; cross-product
  ;;;


  (method (test-cross-product)
    (let ((x (vertex 1. 0. 0.))
          (y (vertex 0. 1. 0.))
          (z (vertex 0. 0. 1.))
          (sight (vertex 0. 0. -1.))
          (up (vertex 0. 1. 0.))
          (right (vertex 1. 0. 0.)))
      ;; axis
      (validate (vertex=? (cross-product x y) z))
      (validate (vertex=? (cross-product y x) (vertex-negate z)))
      
      ;; lookat
      (validate (vertex=? (cross-product sight up) right))))
  
  
  ;;;
  ;;;; ray-intersects-triangle?
  ;;;
  
  
  (method (test-ray-intersects-triangle?)
    (validate (ray-intersects-triangle? (vertex 0. 0. 0.) (vertex 0. 0. 1.) (vertex 0. 1. 1.) (vertex -1. -1. 1.) (vertex 1. -1. 1.)))
    (validate (not (ray-intersects-triangle? (vertex 0. 0. 0.) (vertex 0. 0. -1.) (vertex 0. 1. 1.) (vertex -1. -1. 1.) (vertex 1. -1. 1.))))
    (validate (ray-intersects-triangle? (vertex 0. 0. 0.) (vertex 0. 0. 1.) (vertex 0. 1. 1.) (vertex -1. 0. 1.) (vertex 1. 0. 1.)))
    (validate (not (ray-intersects-triangle? (vertex 0. 0. 0.) (vertex 0. 0. 1.) (vertex 0. 1. 1.) (vertex -1. 0.1 1.) (vertex 1. 0. 1.)))))))
