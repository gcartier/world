;;;==============
;;;  JazzScheme
;;;==============
;;;
;;;; World Debug
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2013
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.debug jazz


(import (jazz.debuggee)
        (jazz.jrm)
        (world)
        (world.autoload)
        (world.syntax (phase syntax)))


(definition public (target-update target face face-rank poly)
  (define (collect-properties elem)
    (collect (lambda (property)
               (let ((name (symbolize-property property)))
                 (unless (memq? name '(before children class-info name-info presentation-info visible? texture))
                   (list name (read-property ?t property)))))
             (get-properties~ (class-of elem))))
  
  (set-?t target)
  (set-?f face)
  (set-?r face-rank)
  (set-?p poly)
  @bugged
  (let ((controller-debugger (get-controller-debugger)))
    (when controller-debugger
      (let ((debuggee (load-object~ (get-local-register) 'world.debuggee 'world-debuggee))
            (debugger (load-object~ (get-remote-register controller-debugger) 'gaia.debugger 'gaia-debugger))
            (first (and target (first target))))
        (let ((class (and first (category-name (class-of first))))
              (properties (and first (collect-properties first))))
          (show-properties~ debugger debuggee class properties))))))


(definition public (set-target-property property value)
  (let ((world (current-world))
        (zone (current-zone)))
    (let ((target (get-target~ world)))
      (if (null? target)
          (bell)
        (for-each (lambda (target)
                    (let ((designer (if (eq? target world) (get-designer~ world) (get-designer~ zone))))
                      (set-property~ designer target property value)))
                  target))))))
