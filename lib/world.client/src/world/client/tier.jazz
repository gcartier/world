;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; Client Tier
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2016
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.client.tier jazz


(import (jazz.debuggee)
        (jazz.graphic)
        (jazz.jrm)
        (jazz.settings)
        (world)
        (world.autoload)
        (world.change)
        (world.client.configuration)
        (world.settings)
        (world.syntax (phase syntax))
        (world.tier))


(class Client-Tier extends Tier
  
  
  (slot client-id       initialize #f getter generate)
  (slot player-id       initialize #f getter generate)
  (slot player-name     initialize #f getter generate)
  (slot player-avatar   initialize #f getter generate)
  (slot player-position initialize #f getter generate)
  (slot player-lookat   initialize #f getter generate)
  (slot other-players   initialize #f getter generate)
  (slot remote-server   initialize #f getter generate)
  (slot remote-client   initialize #f getter generate)
  
  
  (method override (initialize settings)
    (set! settings~self settings)
    (setup))
  
  
  (method override (setup)
    (let ((world (current-world)))
      (register-settings settings)
      (unless (get-controller-debugger)
        (start-remote-listener))
      (connect-to-server)
      (display-message~ world "Connected to server" color: {Color Green})))
  
  
  (method override (install)
    (set-client-id client-id)
    (let ((me (current-me)))
      (register-id~ me player-id)
      (set-name~ me player-name)
      (set-avatar~ me player-avatar)
      (set-position~ me player-position)
      (set-lookat~ me player-lookat))
    (for-each (lambda (info)
                (bind (player-id player-name player-avatar player-position player-lookat) info
                  (add-player player-id player-name player-avatar player-position player-lookat)))
              other-players))
  
  
  (method override (shutdown)
    (let ((world (current-world)))
      (unregister-settings settings)
      (disconnect-from-server)
      (unless (get-controller-debugger)
        (stop-remote-listener))
      (display-message~ world "Disconnected from server")))
  
  
  ;;;
  ;;;; Remote
  ;;;
  
  
  (method override (unimplemented-connected)
    (let ((world (current-world)))
      (display-cancel~ world "Unimplemented when connected")))


  ;;;
  ;;;; Server
  ;;;


  (method (connect-to-server)
    (set! player-name (world-setting 'world.client.player-name #f))
    (set! player-avatar (world-setting 'world.client.player-avatar #f))
    (let ((host (world-client-server-host))
          (port (world-client-server-service)))
      (when (and host port)
        (let ((remote-register (connect-remote-register host port)))
          (let ((server (load-object~ remote-register 'world.server.remote 'world-remote-server))
                (client (load-object~ (get-local-register) 'world.client.remote 'world-remote-client)))
            (set! remote-server server)
            (set! remote-client client)
            (add-exit-job! disconnect-from-server)
            (bind (client-id player-id player-position player-lookat other-players) (client-enter~ server client player-name player-avatar)
              (set! client-id~self client-id)
              (set! player-id~self player-id)
              (set! player-position~self player-position)
              (set! player-lookat~self player-lookat)
              (set! other-players~self other-players)))))))
  
  
  (method (disconnect-from-server)
    (when remote-server
      (client-exit~ remote-server remote-client player-name)
      (set! remote-server #f)
      (set! remote-client #f)))
  
  
  (method (send-client-update changes)
    (client-update~ remote-server remote-client changes))
  
  
  ;;;
  ;;;; Stub
  ;;;
  
  
  (method (add-player player-id player-name player-avatar player-position player-lookat)
    (let ((zone (current-zone)))
      (let ((player (new Player parent: zone name: player-name avatar: player-avatar position: player-position lookat: player-lookat)))
        (register-id~ player player-id)
        (set-billboard-name~ player player-name)
        (add-element~ zone player)
        (add-simulation~ zone player))))
  
  
  (method (remove-player player-name)
    (let ((world (current-world))
          (zone (current-zone)))
      (let ((player (find-player~ world player-name)))
        (remove-simulation~ zone player)
        (remove-element~ zone player))))
  
  
  (method (server-entered player-id player-name player-avatar player-position player-lookat)
    (let ((world (current-world)))
      (add-player player-id player-name player-avatar player-position player-lookat)
      (debug-client 'server-entered player-id player-name player-avatar player-position player-lookat)
      (display-message~ world (format "{a} entered world" player-name))))
  
  
  (method (server-exited player-name)
    (let ((world (current-world)))
      (debug-client 'server-exited player-name)
      (remove-player player-name)
      (display-message~ world (format "{a} exited world" player-name))))
  
  
  (method (server-update changes)
    ;; should probably be applied by a task
    (forward-changes changes))
  
  
  ;;;
  ;;;; Debug
  ;;;
  
  
  (method (debug-client . rest)
    (when (world-setting 'world.client.debug? #f)
      (client-debug~ remote-server remote-client rest)))))
