;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; Billboards
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2018
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.billboard jazz


(import (jazz.geometry)
        (jazz.graphic)
        (world)
        (world.autoload)
        (world.context)
        (world.geometry)
        (world.pane)
        (world.quad-texture)
        (world.syntax (phase syntax)))


(definition public (billboard-matrix& me entity spacing)
  (let ((view (get-view-matrix (current-camera)))
        (matrix (make-translation-matrix& (vertex+& (get-position entity) (vertex& 0. spacing 0.)))))
    (matrix-transpose-3x3! matrix view)
    matrix))


(definition public (console-matrix& me entity spacing)
  (matrix-multiply& (make-translation-matrix& (vertex+& (get-position entity) (vertex& 0. spacing 0.)))
                    (make-x-rotation-matrix (/ PI 6.))))


(definition public (broken-matrix& me entity spacing)
  (matrix-multiply& (make-translation-matrix& (vertex+& (get-position entity) (vertex& 0. spacing 0.)))
                    (make-x-rotation-matrix& (/ PI 3.))
                    (make-y-rotation-matrix& (/ PI 4.))))


(definition public (me-matrix& me entity spacing)
  (matrix-multiply& (make-translation-matrix& (vertex+& (get-position entity) (vertex& 0. spacing 0.)))
                    (make-lookat-matrix& (get-lookat me))
                    (make-y-rotation-matrix PI)))


(definition public (orthogonal-matrix& me entity spacing)
  (matrix-multiply& (make-translation-matrix& (vertex+& (get-position entity) (vertex& 0. spacing 0.)))
                    (make-lookat-matrix& (horizon-lookat& (vertex-normalize& (vertex-& (get-position me) (get-position entity)))))))


(definition public (entity-matrix& me entity spacing)
  (matrix-multiply& (make-translation-matrix& (vertex+& (get-position entity) (vertex& 0. spacing 0.)))
                    (make-lookat-matrix& (get-lookat entity))))


(definition public (auxiliary-matrix& me entity spacing)
  (matrix-multiply& (make-translation-matrix& (vertex+& (get-position entity) spacing))
                    (make-lookat-matrix& (get-lookat entity))))


;;;
;;;; Name
;;;


(definition public (make-name-pane billboard)
  (bind (text font color h) billboard
    (let ((extent (text-extent font text)))
      (let ((width (get-width extent))
            (height (get-height extent)))
        (let ((w (/ (* h width) height)))
          (new Name-Pane
            title: "Name"
            size: (new Dimension$fl$ w h)
            resolution: (new Dimension width height)
            billboard: billboard))))))


(class Name-Pane extends World-Pane
  
  
  (method override (draw self surface)
    (bind (text font color h) billboard
      (let ((extent (text-extent font text)))
        (clear surface)
        (set-font surface font)
        (draw-text surface 0 0 text color))))))
