;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; Audio
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2015
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.audio jazz


(import (jazz.audio)
        (jazz.syntax (phase syntax))
        (world)
        (world.configure)
        (world.log)
        (world.support)
        (world.syntax (phase syntax))
        (world.task))


(definition public (audio-task task <Task>)
  (declare (proper-tail-calls))
  (with-task task "audio" audio-id support-state
    (lambda (log-context exit)
      (let (iter (previous (current-seconds)))
        (let ((time (current-seconds)))
          (let ((elapse (- time previous)))
            (unless (task-stopping?)
              (site (audio on?: #t)
                (trace-task audio "A")
                (update-audio)))
            (let ((duration (- (current-seconds) time)))
              (task-sleep (- audio-rate duration) exit #f))
            (iter time))))))))
