;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; World Meshes
;;;
;;;  The contents of this file are subject to the Mozilla Public License Version
;;;  1.1 (the "License"); you may not use this file except in compliance with
;;;  the License. You may obtain a copy of the License at
;;;  http://www.mozilla.org/MPL/
;;;
;;;  Software distributed under the License is distributed on an "AS IS" basis,
;;;  WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
;;;  for the specific language governing rights and limitations under the
;;;  License.
;;;
;;;  The Original Code is WorldScheme.
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2014
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):
;;;
;;;  Alternatively, the contents of this file may be used under the terms of
;;;  the GNU General Public License Version 2 or later (the "GPL"), in which
;;;  case the provisions of the GPL are applicable instead of those above. If
;;;  you wish to allow use of your version of this file only under the terms of
;;;  the GPL, and not to allow others to use your version of this file under the
;;;  terms of the MPL, indicate your decision by deleting the provisions above
;;;  and replace them with the notice and other provisions required by the GPL.
;;;  If you do not delete the provisions above, a recipient may use your version
;;;  of this file under the terms of any one of the MPL or the GPL.
;;;
;;;  See http://github.com/gcartier/world for details.


(module world.mesh jazz


(import (jazz.graphic.opengl.glew)
        (world.buffer)
        (world.material))


(constant inline vertex-floats <fx>
  10)

(constant inline neighbors-floats <fx>
  7)

(constant inline lightmap-floats <fx>
  3)

(constant inline triangle-floats <fx>
  30
  @wait-constant-folding
  (* 3 vertex-floats))

(constant inline triangle-neighbors-floats <fx>
  21
  @wait-constant-folding
  (* 3 neighbors-floats))

(constant inline triangle-lightmap-floats <fx>
  9
  @wait-constant-folding
  (* 3 lightmap-floats))

(constant inline vertex-stride <fx>
  40
  @wait-constant-folding
  (* 10 float-size))

(constant inline neighbors-stride <fx>
  28
  @wait-constant-folding
  (* 7 float-size))

(constant inline lightmap-stride <fx>
  12
  @wait-constant-folding
  (* 3 float-size))

(constant inline vertex-offset <fx>
  0)

(constant inline normal-offset <fx>
  12
  @wait-constant-folding
  (* 3 float-size))


(constant inline texture-offset <fx>
  24
  @wait-constant-folding
  (* 6 float-size))

(constant inline bone-offset <fx>
  36
  @wait-constant-folding
  (* 9 float-size))

(constant inline swizz-offset <fx>
  0)

(constant inline neighbor1-offset <fx>
  4
  @wait-constant-folding
  float-size)

(constant inline neighbor2-offset <fx>
  16
  @wait-constant-folding
  (* 4 float-size))


;;;
;;;; Mesh
;;;


;; Vertices
;;   triangle1 ...
;;   v1 n1 t1 b1 v2 n2 t2 b2 v3 n3 t3 b3 ...
;;   v1x v1y v1z n1x n1y n1z t1u t1v t1z b1 v2x v2y v2z n2x n2y n2z t2u t2v t2z b2 v3x v3y v3z n3x n3y n3z t3u t3v t3z b3 ...
;;
;; Neighbors
;;   neighbor1 neighbor2 ...
;;   v11 v12 v13 v21 v22 v23 ...
;;
;; Lightmap
;;   l1 l2 l3 ...
;;   l1r l1g l1b l2r l2g l2b l3r l3g l3b ...


(class Mesh extends Object
  
  
  (slot vertices-buffer  <Buffer>   getter generate)
  (slot neighbors-buffer <Buffer>   getter generate)
  (slot lightmap-buffer  <Buffer>   getter generate)
  (slot array            <object>   accessors generate)
  (slot material         <Material> accessors generate)
  
  ;; debug
  (slot vertices-data <object> initialize #f accessors generate)
  (slot lightmap-data <object> initialize #f accessors generate)
  
  
  (method override (initialize (material: material #f))
    (set! vertices-buffer~self (new Buffer))
    (set! neighbors-buffer~self (new Buffer))
    (set! lightmap-buffer~self (new Buffer))
    (set! array~self #f)
    (set! material~self material))
  
  
  (method public (empty?)
    (empty?~ vertices-buffer))
  
  
  (method public (count-floats)
    (+ (or (get-floats~ vertices-buffer) 0)
       @need-to-adjust-debug-info-calculations
       (or (get-floats~ neighbors-buffer) 0)
       @need-to-adjust-debug-info-calculations
       (or (get-floats~ lightmap-buffer) 0)))
  
  
  (method public (setup-array)
    (define (warn msg)
      @w
      (terminal msg))
    
    ;; quick hack
    (if (not material)
        (warn "No material")
      (let ((renderer (get-renderer~ material)))
        ;; quick hack
        (if (not renderer)
            (warn (format "No renderer in {s}" material))
          (let ((program (get-program~ renderer)))
            ;; quick hack
            (if (not program)
                (warn "No program")
              (set! array (create-array~ program self))))))))

  
  (method public (draw)
    (draw~ vertices-buffer))
  
  
  (method public (draw-array)
    (glBindVertexArray array)
    (glDrawArrays GL_TRIANGLES 0 (get-indices~ vertices-buffer))
    (glBindVertexArray 0))
  
  
  (method public (allocate-vertices)
    (generate-buffer~ vertices-buffer))
  
  (method public (allocate-neighbors)
    (generate-buffer~ neighbors-buffer))
  
  (method public (allocate-lightmap)
    (generate-buffer~ lightmap-buffer))
  
  
  (method public (free-vertices)
    (free-buffer~ vertices-buffer))
  
  (method public (free-neighbors)
    (free-buffer~ neighbors-buffer))
  
  (method public (free-lightmap)
    (free-buffer~ lightmap-buffer))
  
  
  (method public (free-resources)
    (free-vertices)
    (free-neighbors)
    (free-lightmap))
  
  
  (method override (destroy)
    (free-resources))))
