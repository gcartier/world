;;;==============
;;;  JazzScheme
;;;==============
;;;
;;;; World Meshes
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2013
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.mesh jazz


(import (world.buffer)
        (world.material))


(constant inline vertex-floats <fx>
  10)

(constant inline neighbors-floats <fx>
  7)

(constant inline lightmap-floats <fx>
  3)

(constant inline triangle-floats <fx>
  30
  @wait-constant-folding
  (* 3 vertex-floats))

(constant inline triangle-neighbors-floats <fx>
  21
  @wait-constant-folding
  (* 3 neighbors-floats))

(constant inline triangle-lightmap-floats <fx>
  9
  @wait-constant-folding
  (* 3 lightmap-floats))


;;;
;;;; Mesh
;;;


;; Vertices
;;   triangle1 ...
;;   v1 n1 t1 b1 v2 n2 t2 b2 v3 n3 t3 b3 ...
;;   v1x v1y v1z n1x n1y n1z t1x t1y t1z b1 v2x v2y v2z n2x n2y n2z t2x t2y t2z b2 v3x v3y v3z n3x n3y n3z t3x t3y t3z b3 ...
;;
;; Neighbors
;;   neighbor1 neighbor2 ...
;;   v11 v12 v13 v21 v22 v23 ...
;;
;; Lightmap
;;   l1 l2 l3 ...
;;   l1r l1g l1b l2r l2g l2b l3r l3g l3b ...


(class Mesh extends Object
  
  
  (slot vertices-buffer  <Buffer>   getter generate)
  (slot neighbors-buffer <Buffer>   getter generate)
  (slot lightmap-buffer  <Buffer>   getter generate)
  (slot material         <Material> accessors generate)
  
  ;; debug
  (slot vertices-data <object> initialize #f accessors generate)
  (slot lightmap-data <object> initialize #f accessors generate)
  
  
  (method override (initialize (material: material #f))
    (set! vertices-buffer~self (new Buffer))
    (set! neighbors-buffer~self (new Buffer))
    (set! lightmap-buffer~self (new Buffer))
    (set! material~self material))
  
  
  (method public (empty?)
    (empty?~ vertices-buffer))
  
  
  (method public (count-floats)
    (+ (or (get-floats~ vertices-buffer) 0)
       @need-to-adjust-debug-info-calculations
       (or (get-floats~ neighbors-buffer) 0)
       @need-to-adjust-debug-info-calculations
       (or (get-floats~ lightmap-buffer) 0)))

  
  (method public (draw)
    (draw~ vertices-buffer))
  
  
  (method public (allocate-vertices)
    (generate-buffer~ vertices-buffer))
  
  (method public (allocate-neighbors)
    (generate-buffer~ neighbors-buffer))
  
  (method public (allocate-lightmap)
    (generate-buffer~ lightmap-buffer))
  
  
  (method public (free-vertices)
    (free-buffer~ vertices-buffer))
  
  (method public (free-neighbors)
    (free-buffer~ neighbors-buffer))
  
  (method public (free-lightmap)
    (free-buffer~ lightmap-buffer))
  
  
  (method public (free-resources)
    (free-vertices)
    (free-neighbors)
    (free-lightmap))
  
  
  (method override (destroy)
    (free-resources))))
