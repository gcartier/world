;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; Rendering
;;;
;;;  The contents of this file are subject to the Mozilla Public License Version
;;;  1.1 (the "License"); you may not use this file except in compliance with
;;;  the License. You may obtain a copy of the License at
;;;  http://www.mozilla.org/MPL/
;;;
;;;  Software distributed under the License is distributed on an "AS IS" basis,
;;;  WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
;;;  for the specific language governing rights and limitations under the
;;;  License.
;;;
;;;  The Original Code is WorldScheme.
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2014
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):
;;;
;;;  Alternatively, the contents of this file may be used under the terms of
;;;  the GNU General Public License Version 2 or later (the "GPL"), in which
;;;  case the provisions of the GPL are applicable instead of those above. If
;;;  you wish to allow use of your version of this file only under the terms of
;;;  the GPL, and not to allow others to use your version of this file under the
;;;  terms of the MPL, indicate your decision by deleting the provisions above
;;;  and replace them with the notice and other provisions required by the GPL.
;;;  If you do not delete the provisions above, a recipient may use your version
;;;  of this file under the terms of any one of the MPL or the GPL.
;;;
;;;  See http://github.com/gcartier/world for details.


(module world.render jazz


(import (jazz.graphic.opengl.glew)
        (jazz.system)
        (world.foreign))


;;;
;;;; Render-Target
;;;


(class Render-Target extends Object
  
  
  (slot color-buffer <int>  initialize #f getter generate)
  (slot depth-buffer <int>  initialize #f getter generate)
  (slot frame-buffer <int>  initialize #f getter generate)
  (slot width        <int>  initialize #f)
  (slot height       <int>  initialize #f)
  
  
  (method override (initialize width height)
    (nextmethod)
    (initialize-buffers width height))
  
  
  (method (initialize-buffers width height)
    (set! width~self width)
    (set! height~self height)
    (initialize-multisampled)
    (initialize-frame-buffer))
  
  
  ;; Initialize using multisample extension
  (method protected (initialize-multisampled)
    (let ((multisampling (find-setting 'world.multisampling 4)))
      ;; color
      (set! color-buffer (glGenRenderbuffers*))
      (glBindRenderbuffer GL_RENDERBUFFER color-buffer)
      (glRenderbufferStorageMultisample GL_RENDERBUFFER multisampling GL_RGBA width height)
      (glBindRenderbuffer GL_RENDERBUFFER 0)
      ;; depth
      (set! depth-buffer (glGenRenderbuffers*))
      (glBindRenderbuffer GL_RENDERBUFFER depth-buffer)
      (glRenderbufferStorageMultisample GL_RENDERBUFFER multisampling GL_DEPTH_COMPONENT32 width height)
      (glBindRenderbuffer GL_RENDERBUFFER 0)))
  
  
  ;; Bind the color and depth buffer in a single framebuffer object
  (method protected (initialize-frame-buffer)
    ;; frame
    (set! frame-buffer (glGenFramebuffers*))
    (glBindFramebuffer GL_FRAMEBUFFER frame-buffer)
    (glFramebufferRenderbuffer GL_FRAMEBUFFER GL_COLOR_ATTACHMENT0 GL_RENDERBUFFER color-buffer)
    (glFramebufferRenderbuffer GL_FRAMEBUFFER GL_DEPTH_ATTACHMENT GL_RENDERBUFFER depth-buffer)
    (glBindFramebuffer GL_FRAMEBUFFER 0))
  
  
  ;;; Set the render target for rendering
  (method public (activate)
    (when frame-buffer
      (glBindFramebuffer GL_FRAMEBUFFER frame-buffer)))
  
  
  ;; Set the render target back to opengl's native buffer
  (method public (deactivate)
    (glBindFramebuffer GL_FRAMEBUFFER 0))
  
  
  (method public (blit destination)
    (glBindFramebuffer GL_READ_FRAMEBUFFER frame-buffer)
    (glBindFramebuffer GL_DRAW_FRAMEBUFFER destination)
    (glBlitFramebuffer 0 0 width height 0 0 width height GL_COLOR_BUFFER_BIT GL_NEAREST)
    (glBindFramebuffer GL_READ_FRAMEBUFFER 0))
  
  
  (method public (resize width height)
    (free-resources)
    (initialize-buffers width height))
  
  
  (method public (free-resources)
    (when color-buffer
      (glDeleteRenderbuffers* color-buffer))
    (when depth-buffer
      (glDeleteRenderbuffers* depth-buffer))
    (when frame-buffer
      (glDeleteFramebuffers* frame-buffer))
    (set! color-buffer #f)
    (set! depth-buffer #f)
    (set! frame-buffer #f))))
