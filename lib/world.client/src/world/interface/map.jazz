;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; World Map Pane
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2016
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.interface.map jazz


(import (jazz.cairo)
        (jazz.geometry)
        (jazz.graphic)
        (jazz.jml)
        (jazz.ui)
        (jazz.view)
        (world)
        (world.actor)
        (world.autoload)
        (world.geometry)
        (world.interface.inventory)
        (world.interface.pane)
        (world.interface.text)
        (world.interface.tooltip)
        (world.player)
        (world.settings)
        (world.syntax (phase syntax)))


;;;
;;;; Biome
;;;


(class Biome extends Object
  
  
  (slot name  getter generate)
  (slot title getter generate)
  (slot id    getter generate)
  (slot color getter generate)
  
  
  (method override (initialize name title id color)
    (set! name~self name)
    (set! title~self title)
    (set! id~self id)
    (set! color~self color))
  
  
  (method override (print output readably)
    (print-unreadable self output
      (lambda (output)
        (format output "{a}" name)))))


(definition protected biome-names <table>
  (make-table test: eq?))

(definition protected biome-ids <vector>
  (make-vector 256 #f))


(definition protected (register-biome name title id color)
  (bind (red green blue) color
    (let ((biome (new Biome name title id (new Color red: red green: green blue: blue))))
      (table-set! biome-names name biome)
      (vector-set! biome-ids id biome)
      (unspecified))))


(definition public (name->biome name) <Biome>
  (table-ref biome-names name #f))

(definition public (id->biome id <fx>) <Biome>
  (vector-ref biome-ids id))


(define-biome ocean                "Ocean"                        0 (0 0 112))
(define-biome plains               "Plains"                       1 (141 179 96))
(define-biome desert               "Desert"                       2 (250 148 24))
(define-biome extremeHills         "Extreme Hills"                3 (96 96 96))
(define-biome forest               "Forest"                       4 (5 102 33))
(define-biome taiga                "Taiga"                        5 (11 102 89))
(define-biome swampland            "Swampland"                    6 (7 249 178))
(define-biome river                "River"                        7 (0 0 255))
(define-biome hell                 "Hell"                         8 (255 0 0))
(define-biome sky                  "Sky"                          9 (128 128 255))
(define-biome frozenOcean          "Frozen Ocean"                10 (144 144 160))
(define-biome frozenRiver          "Frozen River"                11 (160 160 255))
(define-biome icePlains            "Ice Plains"                  12 (255 255 255))
(define-biome iceMountains         "Ice Mountains"               13 (160 160 160))
(define-biome mushroomIsland       "Mushroom Island"             14 (255 0 255))
(define-biome mushroomIslandShore  "Mushroom Island Shore"       15 (160 0 255))
(define-biome beach                "Beach"                       16 (250 222 85))
(define-biome desertHills          "Desert Hills"                17 (210 95 18))
(define-biome forestHills          "Forest Hills"                18 (34 85 28))
(define-biome taigaHills           "Taiga Hills"                 19 (22 57 51))
(define-biome extremeHillsEdge     "Extreme Hills Edge"          20 (114 120 154))
(define-biome jungle               "Jungle"                      21 (83 123 9))
(define-biome jungleHills          "Jungle Hills"                22 (44 66 5))
(define-biome jungleEdge           "Jungle Edge"                 23 (98 139 23))
(define-biome deepOcean            "Deep Ocean"                  24 (0 0 48))
(define-biome stoneBeach           "Stone Beach"                 25 (162 162 132))
(define-biome coldBeach            "Cold Beach"                  26 (250 240 192))
(define-biome birchForest          "Birch Forest"                27 (48 116 68))
(define-biome birchForestHills     "Birch Forest Hills"          28 (31 95 50))
(define-biome roofedForest         "Roofed Forest"               29 (64 81 26))
(define-biome coldTaiga            "Cold Taiga"                  30 (49 85 74))
(define-biome coldTaigaHills       "Cold Taiga Hills"            31 (36 63 54))
(define-biome megaTaiga            "Mega Taiga"                  32 (89 102 81))
(define-biome megaTaigaHills       "Mega Taiga Hills"            33 (69 79 62))
(define-biome extremeHillsPlus     "Extreme Hills+"              34 (80 112 80))
(define-biome savanna              "Savanna"                     35 (189 178 95))
(define-biome savannaPlateau       "Savanna Plateau"             36 (167 157 100))
(define-biome mesa                 "Mesa"                        37 (217 69 21))
(define-biome mesaPlateauF         "Mesa Plateau F"              38 (176 151 101))
(define-biome mesaPlateau          "Mesa Plateau"                39 (202 140 101))
(define-biome oceanM               "Ocean M"                    128 (0 0 112))
(define-biome sunflowerPlains      "Sunflower Plains"           129 (141 179 96))
(define-biome desertM              "Desert M"                   130 (250 148 24))
(define-biome extremeHillsM        "Extreme Hills M"            131 (96 96 96))
(define-biome flowerForest         "Flower Forest"              132 (5 102 33))
(define-biome taigaM               "Taiga M"                    133 (11 102 89))
(define-biome swamplandM           "Swampland M"                134 (7 249 178))
(define-biome riverM               "River M"                    135 (0 0 255))
(define-biome hellM                "Hell M"                     136 (255 0 0))
(define-biome skyM                 "Sky M"                      137 (128 128 255))
(define-biome frozenOceanM         "Frozen Ocean M"             138 (144 144 160))
(define-biome frozenRiverM         "Frozen River M"             139 (160 160 255))
(define-biome icePlainsSpikes      "Ice Plains Spikes"          140 (140 180 180))
(define-biome iceMountainsM        "Ice Mountains M"            141 (160 160 160))
(define-biome mushroomIslandM      "Mushroom Island M"          142 (255 0 255))
(define-biome mushroomIslandShoreM "Mushroom Island Shore M"    143 (160 0 255))
(define-biome beachM               "Beach M"                    144 (250 222 85))
(define-biome desertHillsM         "Desert Hills M"             145 (210 95 18))
(define-biome forestHillsM         "Forest Hills M"             146 (34 85 28))
(define-biome taigaHillsM          "Taiga Hills M"              147 (22 57 51))
(define-biome extremeHillsEdgeM    "Extreme Hills Edge M"       148 (114 120 154))
(define-biome jungleM              "Jungle M"                   149 (83 123 9))
(define-biome jungleHillsM         "Jungle Hills M"             150 (44 66 5))
(define-biome jungleEdgeM          "Jungle Edge M"              151 (98 139 23))
(define-biome deepOceanM           "Deep Ocean M"               152 (0 0 48))
(define-biome stoneBeachM          "Stone Beach M"              153 (162 162 132))
(define-biome coldBeachM           "Cold Beach M"               154 (250 240 192))
(define-biome birchForestM         "Birch Forest M"             155 (48 116 68))
(define-biome birchForestHillsM    "Birch Forest Hills M"       156 (31 95 50))
(define-biome roofedForestM        "Roofed Forest M"            157 (64 81 26))
(define-biome coldTaigaM           "Cold Taiga M"               158 (49 85 74))
(define-biome coldTaigaHillsM      "Cold Taiga Hills M"         159 (36 63 54))
(define-biome megaSpruceTaiga      "Mega Spruce Taiga"          160 (89 102 81))
(define-biome megaSpurceTaigaHills "Mega Spruce Taiga (Hills)"  161 (69 79 62))
(define-biome extremeHillsPlusM    "Extreme Hills+ M"           162 (80 112 80))
(define-biome savannaM             "Savanna M"                  163 (189 178 95))
(define-biome savannaPlateauM      "Savanna Plateau M"          164 (167 157 100))
(define-biome mesaBryce            "Mesa (Bryce)"               165 (217 69 21))
(define-biome mesaPlateauFM        "Mesa Plateau F M"           166 (176 151 101))
(define-biome mesaPlateauM         "Mesa Plateau M"             167 (202 140 101))


;;;
;;;; Map
;;;


(class Map-Pane extends World-Pane
  
  
  (slot scale initialize 1. accessors generate)
  
  
  ;;;
  ;;;; Drawing
  ;;;


  (method override (draw surface context)
    (let ((zone (current-zone)))
      (let ((context (get-context~ surface))
            (bounds (get-bounds)))
        (loop (for region-x from -1 to 2)
              (loop (for region-z from 0 to 1)
                    (let ((region (get-region~ zone region-x region-z)))
                      (loop (for chunk-x from 0 below 32)
                            (loop (for chunk-z from 0 below 32)
                                  (let ((chunk (get-chunk~ region chunk-x chunk-z)))
                                    (let ((biomes (get-biomes~ chunk)))
                                      (loop (for x from 0 to 1)
                                            (loop (for z from 0 to 1)
                                                  (let ((biome (u8vector-ref biomes (+ (* x 8) (* z 8 16))))
                                                        (size 4))
                                                    (let ((h (* (+ (* (+ region-x 1) 64) (* chunk-x 2) x) size))
                                                          (v (* (+ (* region-z 64) (* chunk-z 2) z) size)))
                                                      (let ((rect (new Rect h v (+ h size) (+ v size))))
                                                        (fill-rect~ surface rect (get-color~ (id->biome biome))))))))))))))))))))
