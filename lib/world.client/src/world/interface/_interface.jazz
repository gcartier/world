;;;==============
;;;  JazzScheme
;;;==============
;;;
;;;; World Interface
;;;


(module world.interface jazz


(import (jazz.jml)
        (jazz.graphic)
        (jazz.graphic.opengl.glew)
        (jazz.library)
        (jazz.literals)
        (jazz.platform)
        (jazz.platform.cairo)
        (jazz.ui)
        (world)
        (world.texture))


(class World-Interface extends Layout-View
  
  
  (form
    (<install> layout-type: center))
  
  
  (slot texture initialize #f getter generate)
  
  
  (method override (finish initargs)
    (nextmethod initargs)
    (set! texture (make-cairo-texture 1200 800 program: (get-texture-program~ world) overlay: 0.))
    (set! modified? #t))
  
  
  (method override (size-change size)
    (nextmethod size)
    (set! texture (make-cairo-texture (get-width~ size) (get-height~ size) program: (get-texture-program~ world) overlay: 0.)))
  
  
  (method (draw-interface)
    (for-each (lambda (pane)
                (when (and (is? pane world.interface.pane:Pane) (get-visible?~ pane))
                  (draw-pane~ pane)))
              children)
    (let ((surface (get-surface~ texture))
          (width (cast <fl> (get-width)))
          (height (cast <fl> (get-height))))
      (when modified?
        (set-operator~ surface CAIRO_OPERATOR_CLEAR)
        (paint~ surface)
        (set-operator~ surface CAIRO_OPERATOR_OVER)
        (set-clipper~ surface (new Rect 0 0 width height))
        (paint-drawing surface '())
        (map-texture~ texture)
        (set! modified? #f))
      (textured-quad~ texture
        (lambda () (glVertex3f 0.0 0.0 0.0))
        (lambda () (glVertex3f width 0.0 0.0))
        (lambda () (glVertex3f width height 0.0))
        (lambda () (glVertex3f 0.0 height 0.0)))))))
