;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; Mobile Server
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2018
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.server.mobile jazz


(import (jazz.network)
        (world)
        (world.server)
        (world.server.client)
        (world.settings))


(definition package mobile-server
  #f)

(definition package mobile-server-connect
  #f)

(definition package mobile-service-offset
  50)


(definition package (start-mobile-server mobile-connect)
  (let ((configuration (get-server-configuration)))
    (let ((host (effective-host configuration))
          (service (+ (effective-service configuration) mobile-service-offset)))
      (let ((server (new Mobile-Server host: host service: service)))
        (start server)
        (set! mobile-server server)
        (set! mobile-server-connect mobile-connect)))))


(definition package (stop-mobile-server)
  (when mobile-server
    (stop mobile-server)
    (set! mobile-server #f)))


;;;
;;;; Server
;;;


(class Mobile-Server extends TCP-Server
  
  
  (method override (server-name self)
    'mobile-server)
  
  
  (method override (connection-name self)
    'mobile-connection)
  
  
  (method override (accept-connection self port)
    (mobile-server-connect port)))


;;;
;;;; Delegate
;;;


(class Mobile-Delegate extends Client-Delegate
  
  
  (slot port accessors generate)
  
  
  (method override (initialize self port state id no name role admin?)
    (nextmethod self #f state #f id no name #f #f #f role admin?)
    (set! self.port port))
  
  
  (method override (mobile? self)
    #t)
  
  
  ;; quick solution never disconnect for now
  (method override (still-alive? self)
    #t)
  
  
  ;; quick solution never disconnect for now
  (method override (disconnected-giveup? self)
    #f)))
