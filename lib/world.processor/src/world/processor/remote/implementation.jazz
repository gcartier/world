;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; World Remote Processor Implementation
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2018
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.processor.remote.implementation jazz


(import (jazz.presence)
        (jazz.syntax (phase syntax))
        (world)
        (world.autoload)
        (world.context)
        (world.processor)
        (world.support)
        (world.syntax (phase syntax))
        (world.task)
        (world.tier)
        (world.work))


(definition (with-processor proc)
  (with-task-mutex
    (lambda ()
      (let ((tier (current-tier+)))
        (if (and tier
                 (is? tier Processor-Tier)
                 (not shutdown?)
                 (not being-debugged?))
            (continuation-capture
              (lambda (exit)
                (parameterize ((current-exit exit))
                  (proc tier))))
          disconnect-marker)))))


(class World-Remote-Processor extends Object
  
  
  (method public (processor-setup self server server-path zone)
    (processor-setup (current-tier) server server-path zone))
  
  
  (method public (processor-quit self)
    (processor-quit (current-tier)))
  
  
  (method public (client-enter self client client-id client-no character-name character-avatar character-script)
    (client-enter (current-tier) client client-id client-no character-name character-avatar character-script))
  
  
  (method public (client-exit self client character-name)
    (client-exit (current-tier) client character-name))
  
  
  (method public (client-update self client sent changes)
    (with-processor
      (lambda (processor)
        (client-update processor client sent changes))))
  
  
  (method public (retrieve-region self region-index)
    (with-processor
      (lambda (processor)
        (retrieve-region processor region-index))))
  
  
  (method public (retrieve-chunk self region-index chunk-index chunk-digest)
    (with-processor
      (lambda (processor)
        (retrieve-chunk processor region-index chunk-index chunk-digest))))
  
  
  (method public (retrieve-entity self id)
    (with-processor
      (lambda (processor)
        (retrieve-entity processor id))))))
