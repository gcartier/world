;;;===============
;;;  WorldScheme
;;;===============
;;;
;;;; World Remote Processor Implementation
;;;
;;;  The Initial Developer of the Original Code is Guillaume Cartier.
;;;  Portions created by the Initial Developer are Copyright (C) 2012-2018
;;;  the Initial Developer. All Rights Reserved.
;;;
;;;  Contributor(s):


(module world.processor.remote.implementation jazz


(import (world.autoload)
        (world.context)
        (world.processor.tier)
        (world.support)
        (world.task)
        (world.tier))


(definition (with-processor proc)
  (with-task-mutex
    (lambda ()
      (let ((tier (current-tier+)))
        (if (and tier
                 (is? tier Processor-Tier)
                 (not shutdown?)
                 (not being-debugged?))
            (continuation-capture
              (lambda (exit)
                (parameterize ((current-exit exit))
                  (proc tier))))
          disconnect-marker)))))


(class World-Remote-Processor extends Object
  
  
  (method public (processor-setup self server server-path processor-id processor-no zone)
    (with-processor
      (lambda (tier)
        (processor-setup tier server server-path processor-id processor-no zone))))
  
  
  (method public (processor-quit self)
    (with-processor
      (lambda (tier)
        (processor-quit tier))))
  
  
  (method public (client-enter self client client-uuid client-id client-no character-name character-avatar character-script character-role)
    (with-processor
      (lambda (tier)
        (client-enter tier client client-uuid client-id client-no character-name character-avatar character-script character-role))))
    
  
  (method public (client-save self client character-name camera-position camera-lookat)
    (with-processor
      (lambda (tier)
        (client-save tier client character-name camera-position camera-lookat))))

  
  (method public (client-exit self client character-name)
    (with-processor
      (lambda (tier)
        (client-exit tier client character-name))))
  
  
  (method public (client-update self client sent changes)
    (with-processor
      (lambda (tier)
        (client-update tier client sent changes))))
  
  
  (method public (retrieve-region self region-index)
    (with-processor
      (lambda (tier)
        (retrieve-region tier region-index))))
  
  
  (method public (retrieve-chunk self region-index chunk-index chunk-digest)
    (with-processor
      (lambda (tier)
        (retrieve-chunk tier region-index chunk-index chunk-digest))))
  
  
  (method public (retrieve-entity self id)
    (with-processor
      (lambda (tier)
        (retrieve-entity tier id))))
  
  
  (method public (pause self)
    (with-processor
      (lambda (tier)
        (pause tier))))
  
  
  (method public (unpause self)
    (with-processor
      (lambda (tier)
        (unpause tier))))))
