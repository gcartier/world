From 77d9de47aca902a4f3c4d6b5411c0e9fb017ce45 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=C3=89douard=20H=C3=A9bert?= <edohebert12@gmail.com>
Date: Thu, 1 Oct 2015 15:30:41 -0400
Subject: [PATCH] In work

---
 lib/world.client/src/world/configure.jazz            | 10 ++++++++++
 lib/world.client/src/world/interface/inventory.jazz  |  2 +-
 lib/world/src/world/external/minecraft/generate.jazz |  6 +++++-
 lib/world/src/world/log.jazz                         |  3 +++
 lib/world/src/world/zone.jazz                        |  2 ++
 5 files changed, 21 insertions(+), 2 deletions(-)

diff --git a/lib/world.client/src/world/configure.jazz b/lib/world.client/src/world/configure.jazz
index bf2926f..8191f96 100644
--- a/lib/world.client/src/world/configure.jazz
+++ b/lib/world.client/src/world/configure.jazz
@@ -32,6 +32,7 @@
 (definition default-spawn-priority    1.)
 (definition default-redstone-priority 1.)
 (definition default-lava-priority     1.)
+(definition default-water-priority    1.)
 (definition default-generate-priority 0.)
 
 
@@ -122,6 +123,9 @@
 (definition public lava-priority <fl>
   (world-setting 'world.lava-priority default-lava-priority))
 
+(definition public water-priority <fl>
+  (world-setting 'world.water-priority default-water-priority))
+
 (definition public sun-max <fl>
   (world-setting 'world.sun-max 60.))
 
@@ -146,6 +150,12 @@
 (definition public lava-rate <fl>
   (/ 1. lava-max))
 
+(definition public water-max <fl>
+  (world-setting 'world.water-max (/ 5. 4.)))
+
+(definition public water-rate <fl>
+  (/ 1. water-max))
+
 
 (definition public log? <bool>
   (world-setting 'world.log? #t))
diff --git a/lib/world.client/src/world/interface/inventory.jazz b/lib/world.client/src/world/interface/inventory.jazz
index bc17835..e4c7ceb 100644
--- a/lib/world.client/src/world/interface/inventory.jazz
+++ b/lib/world.client/src/world/interface/inventory.jazz
@@ -287,7 +287,7 @@
     (begin
       (set-id~ (table-ref slot-table 0) 1)
       (set-number~ (table-ref slot-table 0) 1)
-      (set-id~ (table-ref slot-table 1) 2)
+      (set-id~ (table-ref slot-table 1) 11)
       (set-number~ (table-ref slot-table 1) 1)
       (set-id~ (table-ref slot-table 2) 29)
       (set-number~ (table-ref slot-table 2) 1)
diff --git a/lib/world/src/world/external/minecraft/generate.jazz b/lib/world/src/world/external/minecraft/generate.jazz
index 35fedcd..7a4966b 100644
--- a/lib/world/src/world/external/minecraft/generate.jazz
+++ b/lib/world/src/world/external/minecraft/generate.jazz
@@ -3926,7 +3926,11 @@
                                 (if (= level-set 7)
                                     (begin
                                       (block-set! section index 0)
-                                      (data-set! section index 0))
+                                      (data-set! section index 0)
+                                      (with-field i (- j 1) k
+                                        (lambda (section index)
+                                          (when (memq? (block-ref section index) '(10 11))
+                                            (enqueue new-lava-blocks (cons (get-sector~ section) (index->coordinates index)))))))
                                   (when (/= level-set data)
                                     (data-set! section index level-set)))
                                 (when (/= level-set data)
diff --git a/lib/world/src/world/log.jazz b/lib/world/src/world/log.jazz
index caab93c..dc9d383 100644
--- a/lib/world/src/world/log.jazz
+++ b/lib/world/src/world/log.jazz
@@ -35,6 +35,7 @@
 (definition public spawn-id (context!))
 (definition public redstone-id (context!))
 (definition public lava-id (context!))
+(definition public water-id (context!))
 ;(definition public message-id (context!))
 
 
@@ -62,6 +63,7 @@
 (definition public spawn-sequential-state (state!))
 (definition public redstone-sequential-state (state!))
 (definition public lava-sequential-state (state!))
+(definition public water-sequential-state (state!))
 
 
 (definition logs-directory
@@ -102,6 +104,7 @@
     (log-define-state log-context spawn-sequential-state "spawn sequential" log-BLUE)
     (log-define-state log-context redstone-sequential-state "redstone sequential" log-BLUE)
     (log-define-state log-context lava-sequential-state "lava sequential" log-BLUE)
+    (log-define-state log-context water-sequential-state "water sequential" log-BLUE)
 
     log-context))
 
diff --git a/lib/world/src/world/zone.jazz b/lib/world/src/world/zone.jazz
index 1fdc203..e7d01ee 100644
--- a/lib/world/src/world/zone.jazz
+++ b/lib/world/src/world/zone.jazz
@@ -91,6 +91,7 @@
   (property spawn?                  <bool>       initialize #t              accessors generate)
   (property redstone?               <bool>       initialize #t              accessors generate)
   (property lava?                   <bool>       initialize #t              accessors generate)
+  (property water?                  <bool>       initialize #t              accessors generate)
   (property start-time              <object>     initialize 'day            accessors generate)
   (property start-skybox            <object>     initialize #f              accessors generate)
   (property atlas-name              <object>     initialize #f              accessors generate)
@@ -198,6 +199,7 @@
     (set! spawn? (and spawn? (world-setting 'world.spawn? #t)))
     (set! redstone? (and redstone? (world-setting 'world.redstone? #t)))
     (set! lava? (and lava? (world-setting 'world.lava? #t)))
+    (set! water? (and water? (world-setting 'world.water? #t)))
     (cond ((sun-light?)
            (set-sun-effective~ lighting sun-color)
            (set-sun-coordinates~ lighting (vertex 10000.0 10000.0 10000.0)))
-- 
1.9.5.msysgit.1

